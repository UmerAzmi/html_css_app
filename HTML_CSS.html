<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browser Bot's Web Workshop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .font-mono {
            font-family: 'Fira Code', monospace;
        }
        /* Make code blocks stand out */
        code {
            font-family: 'Fira Code', monospace;
            background-color: #374151; /* gray-700 */
            color: #f3f4f6; /* gray-100 */
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-size: 0.9em;
        }
        /* Chat bubble styles */
        .chat-bubble {
            max-width: 85%;
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            margin-bottom: 0.5rem;
            line-height: 1.6;
            word-wrap: break-word;
            opacity: 0;
            transform: translateY(10px);
            animation: popIn 0.3s forwards;
        }

        @keyframes popIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-bubble-bot {
            background-color: #374151; /* gray-700 */
            color: #d1d5db; /* gray-300 */
            border-bottom-left-radius: 0.25rem;
            align-self: flex-start;
        }

        .chat-bubble-user {
            background-color: #166534; /* green-800 */
            color: #d1fae5; /* green-100 */
            border-bottom-right-radius: 0.25rem;
            align-self: flex-end;
        }
        
        .chat-bubble-feedback {
            background-color: #2563eb; /* blue-600 */
            color: #dbeafe; /* blue-100 */
            border-bottom-right-radius: 0.25rem; /* Should this be border-bottom-left-radius? */
            align-self: flex-start; /* Feedback comes from bot */
            text-align: center;
            max-width: fit-content; /* Make it just wide enough for text */
            margin-left: auto; /* Push to center if needed, or adjust alignment */
            margin-right: auto;
        }


        .chat-bubble-error {
            background-color: #991b1b; /* red-800 */
            color: #fecaca; /* red-200 */
            border-bottom-left-radius: 0.25rem;
            align-self: flex-start;
        }
        
        /* Explain button style */
        .explain-button-container {
            align-self: flex-end;
            margin-top: -6px; /* Pull it up slightly */
            margin-bottom: 8px; /* Add space below it */
            margin-right: 4px;
        }

        .gemini-explain-button {
            background-color: #7c3aed; /* purple-600 */
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            transition: background-color 0.3s;
            border: none;
            cursor: pointer;
        }
        .gemini-explain-button:hover {
            background-color: #6d28d9; /* purple-700 */
        }
        .gemini-explain-button:disabled {
            background-color: #585063;
            cursor: not-allowed;
        }

        .chat-output::-webkit-scrollbar {
            width: 6px;
        }
        .chat-output::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
        }
        .chat-output::-webkit-scrollbar-thumb {
            background-color: #4b5563; /* gray-600 */
            border-radius: 3px;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 h-screen">

    <!-- Main Hub View -->
    <div id="hub-view" class="flex flex-col items-center justify-center h-full p-8">
        <div class="text-center">
            <div class="text-6xl mb-4">ðŸ¤–</div>
            <h1 class="text-4xl font-bold text-green-300">Welcome to Browser Bot's Web Workshop!</h1>
            <p class="text-xl text-gray-400 mt-2">Your friendly guide to building the web.</p>
            <p class="text-lg text-gray-300 mt-8">Which track would you like to start?</p>
        </div>
        <div class="flex flex-col md:flex-row gap-6 mt-8 w-full max-w-4xl">
            <!-- HTML Track Card -->
            <button data-track="html" class="hub-button flex-1 bg-gray-800 p-8 rounded-lg shadow-lg hover:bg-gray-700 hover:shadow-cyan-500/30 transition-all duration-300 border border-transparent hover:border-cyan-400">
                <div class="text-4xl mb-3">ðŸ“„</div>
                <h2 class="text-2xl font-bold text-cyan-300 mb-2">HTML</h2>
                <p class="text-gray-400">Learn the skeleton of all websites. Master tags, forms, and structure.</p>
            </button>
            <!-- CSS Track Card -->
            <button data-track="css" class="hub-button flex-1 bg-gray-800 p-8 rounded-lg shadow-lg hover:bg-gray-700 hover:shadow-purple-500/30 transition-all duration-300 border border-transparent hover:border-purple-400">
                <div class="text-4xl mb-3">ðŸŽ¨</div>
                <h2 class="text-2xl font-bold text-purple-300 mb-2">CSS</h2>
                <p class="text-gray-400">Give your websites style! Learn colors, layout, fonts, and the box model.</p>
            </button>
            <!-- Combined Track Card -->
            <button data-track="combined" class="hub-button flex-1 bg-gray-800 p-8 rounded-lg shadow-lg hover:bg-gray-700 hover:shadow-yellow-500/30 transition-all duration-300 border border-transparent hover:border-yellow-400">
                <div class="text-4xl mb-3">ðŸš€</div>
                <h2 class="text-2xl font-bold text-yellow-300 mb-2">Combined Projects</h2>
                <p class="text-gray-400">Put it all together! Build small projects using both HTML and CSS.</p>
            </button>
        </div>
    </div>

    <!-- Main Game View (hidden by default) -->
    <div id="game-view" class="hidden flex flex-col md:flex-row h-full p-4 gap-4">
        
        <!-- Main Game Area -->
        <div class="flex flex-col flex-grow md:w-3/4 h-full bg-gray-800 rounded-lg shadow-lg overflow-hidden">
            <!-- Character Header -->
            <div class="flex items-center p-3 bg-gray-700 border-b border-gray-600">
                <div class="text-4xl mr-3">ðŸ¤–</div>
                <div>
                    <h3 class="font-bold text-lg text-green-300">Browser Bot</h3>
                    <p class="text-xs text-gray-400">Your friendly guide to building the web</p>
                </div>
            </div>
            
            <!-- Chat Output -->
            <div id="chat-output" class="flex-grow p-4 overflow-y-auto text-sm leading-relaxed chat-output flex flex-col space-y-2">
                <!-- Chat messages will be dynamically added here -->
            </div>
            
            <!-- Terminal Input -->
            <div class="flex items-start p-2 bg-gray-900 border-t border-gray-700">
                <span class="text-green-400 mr-2 mt-2 font-mono">&gt;</span>
                <textarea id="terminal-input" class="bg-transparent border-none text-gray-200 w-full focus:outline-none resize-none font-mono" rows="1" placeholder="Type your code here" autocomplete="off"></textarea>
                <button id="submit-button" class="ml-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition duration-300 w-10 h-10 flex items-center justify-center flex-shrink-0 self-end">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Sidebar/Info Panel -->
        <div class="flex flex-col md:w-1/4 h-full bg-gray-800 rounded-lg shadow-lg p-4 space-y-4 overflow-y-auto">
            <div>
                <h2 class="text-lg font-bold text-green-400 border-b border-gray-600 pb-2 mb-2">Objective</h2>
                <p id="objective" class="text-sm text-gray-300"></p>
            </div>
            <div>
                <h2 class="text-lg font-bold text-yellow-400 border-b border-gray-600 pb-2 mb-2">Current File</h2>
                <div id="file-info" class="text-sm space-y-2">
                    <!-- Schema info will be dynamically added here -->
                </div>
            </div>
            <div>
                <h2 class="text-lg font-bold text-orange-400 border-b border-gray-600 pb-2 mb-2">Need Help?</h2>
                <div class="flex space-x-2">
                    <button id="hint-button" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded transition duration-300">Get Hint</button>
                    <button id="show-answer-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-300">Answer</button>
                </div>
                <p class="text-xs text-gray-500 mt-2 text-center">(Ctrl+Enter or click Send to Submit)</p>
            </div>
            <div class="flex-grow"></div>
            <div>
                <button id="back-to-hub-button" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded transition duration-300">
                    &larr; Back to Hub
                </button>
                <button id="reset-button" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition duration-300 mt-2">
                    Restart Track
                </button>
            </div>
        </div>
    </div>
    
    <!-- Preview Modal -->
    <div id="preview-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white text-gray-800 rounded-lg shadow-xl w-full max-w-2xl transform transition-all h-3/4 flex flex-col">
            <div class="flex justify-between items-center p-3 bg-gray-100 border-b rounded-t-lg flex-shrink-0">
                <div class="flex items-center space-x-2">
                    <span class="w-3 h-3 bg-red-500 rounded-full"></span>
                    <span class="w-3 h-3 bg-yellow-500 rounded-full"></span>
                    <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                </div>
                <p class="text-sm text-gray-500">Browser Preview</p>
                <button id="close-modal-button" class="text-gray-600 hover:text-gray-900 text-2xl font-bold">&times;</button>
            </div>
            <div class="flex-grow h-full">
                <iframe id="preview-iframe" class="w-full h-full border-0"></iframe>
            </div>
        </div>
    </div>


<script type="module">
    // --- START: LESSON TRACKS EMBEDDED ---

    const htmlLessons = [
        {
            story: "Bleep bloop! Welcome to the HTML track. Every HTML page has a basic structure: <code>&lt;!DOCTYPE html&gt;</code>, <code>&lt;html&gt;</code>, <code>&lt;head&gt;</code> (for metadata like the title), and <code>&lt;body&gt;</code> (for all your content). I'll wrap your code in this structure automatically, so you just need to focus on the tags that go *inside* the <code>&lt;body&gt;</code>. Type 'ready' to begin!",
            objective: "Learn the basic HTML document structure.",
            file: "index.html",
            hint: "Just type 'ready' in the terminal!",
            solution: "ready",
            preview: false,
            successMessage: "Great! Let's create our first tag."
        },
        {
            story: "Bleep! Let's create a main title. In HTML, we use 'tags' to tell the browser what kind of content something is. For a 'Heading Level 1' (the biggest, most important title), we use the <code>&lt;h1&gt;</code> tag. Tags usually wrap your content with an opening tag (<code>&lt;h1&gt;</code>) and a closing tag (<code>&lt;/h1&gt;</code>). Your turn: Write a heading that says 'My First Webpage'.",
            objective: "Create an <h1> tag.",
            file: "index.html",
            hint: "Use <h1> and </h1> around your text, like this: <code>&lt;h1&gt;Your Text Here&lt;/h1&gt;</code>",
            solution: /<h1>\s*My First Webpage\s*<\/h1>/i,
            fullAnswer: "<h1>My First Webpage</h1>",
            preview: true,
            successMessage: "Excellent! You've created a heading. Now let's add some regular text."
        },
        {
            story: "Awesome! Now, for a normal paragraph of text, we use the 'paragraph' tag, which is <code>&lt;p&gt;</code>. Just like <code>&lt;h1&gt;</code>, it needs an opening and closing tag. Add a paragraph that says: 'This is my first paragraph.'",
            objective: "Create a <p> tag.",
            file: "index.html",
            hint: "Use <p> and </p> around your text.",
            solution: /<p>\s*This is my first paragraph\.\s*<\/p>/i,
            fullAnswer: "<p>This is my first paragraph.</p>",
            preview: true,
            successMessage: "Perfect! You're getting the hang of this. Tags just give structure. Let's add another paragraph."
        },
        {
            story: "Let's add one more paragraph just for practice. Add a <code>&lt;p&gt;</code> tag that says: 'HTML is fun!'",
            objective: "Create a second <p> tag.",
            file: "index.html",
            hint: "It's the same as the last step, just with different text.",
            solution: /<p>\s*HTML is fun!\s*<\/p>/i,
            fullAnswer: "<p>HTML is fun!</p>",
            preview: true,
            successMessage: "Bleep! You're a natural. Now, what about lists?"
        },
        {
            story: "To make a bulleted list, you need two types of tags. First, the 'unordered list' tag (<code>&lt;ul&gt;</code>) to wrap the *whole* list. Then, each 'list item' inside gets its own <code>&lt;li&gt;</code> tag. Try making a list with two items: 'Apples' and 'Bananas'.",
            objective: "Create a <ul> with <li> items.",
            file: "index.html",
            hint: "The structure should be: <code>&lt;ul&gt;&lt;li&gt;Apples&lt;/li&gt;&lt;li&gt;Bananas&lt;/li&gt;&lt;/ul&gt;</code>",
            solution: /<ul>\s*<li>\s*Apples\s*<\/li>\s*<li>\s*Bananas\s*<\/li>\s*<\/ul>/i,
            fullAnswer: "<ul>\n  <li>Apples</li>\n  <li>Bananas</li>\n</ul>",
            preview: true,
            successMessage: "Great list! You've learned headings, paragraphs, and lists. That's a huge part of HTML!"
        },
        {
            story: "How about an image? The image tag is special: <code>&lt;img&gt;</code>. It's 'self-closing', so it doesn't need a closing tag. It *does* need a 'source' attribute, <code>src</code>, to tell it where to find the image. Let's add a 200x200 placeholder image.",
            objective: "Add an <img> tag.",
            file: "index.html",
            hint: "Use the tag: <code>&lt;img src=\"https://placehold.co/200x200\"&gt;</code>",
            solution: /<img\s+src=['"]https:\/\/placehold.co\/200x200['"]\s*>/i,
            fullAnswer: "<img src=\"https://placehold.co/200x200\">",
            preview: true,
            successMessage: "Bzzzt! Look at that! You've added an image to your webpage."
        },
        // --- NEW HTML LESSONS START HERE ---
        {
            story: "Great! But what if the image doesn't load? We should add an <code>alt</code> attribute (alternative text). This is crucial for accessibility (screen readers) and SEO. Add alt text that says 'A 200x200 placeholder'.",
            objective: "Add an 'alt' attribute to an <img> tag.",
            file: "index.html",
            hint: "Add <code>alt=\"A 200x200 placeholder\"</code> inside your <code>&lt;img&gt;</code> tag.",
            solution: /<img\s+src=['"]https:\/\/placehold.co\/200x200['"]\s+alt=['"]A 200x200 placeholder['"]\s*>/i,
            fullAnswer: "<img src=\"https://placehold.co/200x200\" alt=\"A 200x200 placeholder\">",
            preview: true,
            successMessage: "Perfect! That makes our page much more robust. Now, let's add a link."
        },
        {
            story: "Let's link to another website. We use the 'anchor' tag, <code>&lt;a&gt;</code>. It needs an <code>href</code> attribute (hyperlink reference) to set the destination. Create a link to Google that says 'Visit Google'.",
            objective: "Create an <a> (link) tag.",
            file: "index.html",
            hint: "Use <code>&lt;a href=\"https://www.google.com\"&gt;Visit Google&lt;/a&gt;</code>",
            solution: /<a\s+href=['"]https:\/\/www.google.com['"]\s*>\s*Visit Google\s*<\/a>/i,
            fullAnswer: "<a href=\"https://www.google.com\">Visit Google</a>",
            preview: true,
            successMessage: "Bleep! You've created a link. This is the 'HyperText' in HTML!"
        },
        {
            story: "Right now, all our tags are just one after another. To group them, we can use a <code>&lt;div&gt;</code> tag. It's a 'division' or container. Let's wrap our two paragraphs from earlier inside a <code>&lt;div&gt;</code>.",
            objective: "Wrap elements in a <div> tag.",
            file: "index.html",
            hint: "Put <code>&lt;div&gt;</code> before the first <code>&lt;p&gt;</code> and <code>&lt;/div&gt;</code> after the second <code>&lt;p&gt;</code>.",
            solution: /<div>\s*<p>\s*This is my first paragraph\.\s*<\/p>\s*<p>\s*HTML is fun!\s*<\/p>\s*<\/div>/i,
            fullAnswer: "<div>\n  <p>This is my first paragraph.</p>\n  <p>HTML is fun!</p>\n</div>",
            preview: true,
            successMessage: "Great! It won't look different yet, but <code>&lt;div&gt;</code> is essential for styling. Now let's talk about attributes."
        },
        {
            story: "We can give tags special names. A <code>class</code> attribute can be used on *many* elements. An <code>id</code> attribute must be unique to *one* element. Let's add a <code>class</code> of 'highlight' to our 'HTML is fun!' paragraph.",
            objective: "Add a 'class' attribute to a <p> tag.",
            file: "index.html",
            hint: "Change <code>&lt;p&gt;HTML is fun!&lt;/p&gt;</code> to <code>&lt;p class=\"highlight\"&gt;HTML is fun!&lt;/p&gt;</code>",
            solution: /<p\s+class=['"]highlight['"]\s*>\s*HTML is fun!\s*<\/p>/i,
            fullAnswer: "<p class=\"highlight\">HTML is fun!</p>",
            preview: true,
            successMessage: "Bleep! That <code>&lt;p&gt;</code> tag now has a class. We can use this to target it with CSS!"
        },
        {
            story: "Let's add a unique <code>id</code>. Add an <code>id</code> of 'main-title' to your <code>&lt;h1&gt;</code> tag.",
            objective: "Add an 'id' attribute to an <h1> tag.",
            file: "index.html",
            hint: "Change <code>&lt;h1&gt;...&lt;/h1&gt;</code> to <code>&lt;h1 id=\"main-title\"&gt;...&lt;/h1&gt;</code>",
            solution: /<h1\s+id=['"]main-title['"]\s*>\s*My First Webpage\s*<\/h1>/i,
            fullAnswer: "<h1 id=\"main-title\">My First Webpage</h1>",
            preview: true,
            successMessage: "Excellent! That <code>&lt;h1&gt;</code> is now uniquely identifiable."
        },
        {
            story: "Time for forms! The <code>&lt;form&gt;</code> tag is a container for inputs. Let's create an empty form.",
            objective: "Create an empty <form> tag.",
            file: "index.html",
            hint: "Just add <code>&lt;form&gt;&lt;/form&gt;</code>.",
            solution: /<form>\s*<\/form>/i,
            fullAnswer: "<form></form>",
            preview: true,
            successMessage: "Great! Now let's add a place for the user to type."
        },
        {
            story: "Inside your form, add an <code>&lt;input&gt;</code> tag. We also need a <code>&lt;label&gt;</code> for accessibility. Let's make a label that says 'Name:' and an input tag.",
            objective: "Add a <label> and <input> to the form.",
            file: "index.html",
            hint: "Add this inside your form: <code>&lt;label&gt;Name:&lt;/label&gt;&lt;input&gt;</code>",
            solution: /<form>\s*<label>\s*Name:\s*<\/label>\s*<input>\s*<\/form>/i,
            fullAnswer: "<form>\n  <label>Name:</label>\n  <input>\n</form>",
            preview: true,
            successMessage: "Good! But the label and input aren't connected. Let's fix that."
        },
        {
            story: "To connect them, we use <code>id</code> and <code>for</code>. Give the <code>&lt;input&gt;</code> an <code>id=\"user-name\"</code> and the <code>&lt;label&gt;</code> a <code>for=\"user-name\"</code>. (Now clicking the label will focus the input!)",
            objective: "Connect a <label> to an <input>.",
            file: "index.html",
            hint: "<code>&lt;label for=\"user-name\"&gt;Name:&lt;/label&gt;&lt;input id=\"user-name\"&gt;</code>",
            solution: /<form>\s*<label\s+for=['"]user-name['"]\s*>\s*Name:\s*<\/label>\s*<input\s+id=['"]user-name['"]\s*>\s*<\/form>/i,
            fullAnswer: "<form>\n  <label for=\"user-name\">Name:</label>\n  <input id=\"user-name\">\n</form>",
            preview: true,
            successMessage: "Perfect! They are now semantically linked. Finally, a form needs a submit button."
        },
        {
            story: "Add a <code>&lt;button&gt;</code> tag inside your form, after the input. Let it say 'Submit'.",
            objective: "Add a <button> to the form.",
            file: "index.html",
            hint: "Add <code>&lt;button&gt;Submit&lt;/button&gt;</code> inside the <code>&lt;form&gt;</code>.",
            solution: /<form>(.|\n)*<input\s+id=['"]user-name['"]\s*>(.|\n)*<button>\s*Submit\s*<\/button>\s*<\/form>/i,
            fullAnswer: "<form>\n  <label for=\"user-name\">Name:</label>\n  <input id=\"user-name\">\n  <button>Submit</button>\n</form>",
            preview: true,
            successMessage: "Bzzzt! You've built a complete HTML form. Amazing!"
        },
        {
            story: "One last thing! HTML5 has 'semantic' tags that describe their content. Instead of <code>&lt;div&gt;</code> for everything, we use tags like <code>&lt;header&gt;</code>, <code>&lt;footer&gt;</code>, and <code>&lt;nav&gt;</code>. Let's create an empty <code>&lt;header&gt;</code>.",
            objective: "Create an empty <header> tag.",
            file: "index.html",
            hint: "Just add <code>&lt;header&gt;&lt;/header&gt;</code>.",
            solution: /<header>\s*<\/header>/i,
            fullAnswer: "<header></header>",
            preview: false,
            successMessage: "Great! That tells the browser 'this is the top of the page'."
        },
        {
            story: "Now create an empty <code>&lt;footer&gt;</code> tag for the bottom of the page.",
            objective: "Create an empty <footer> tag.",
            file: "index.html",
            hint: "Just add <code>&lt;footer&gt;&lt;/footer&gt;</code>.",
            solution: /<footer>\s*<\/footer>/i,
            fullAnswer: "<footer></footer>",
            preview: false,
            successMessage: "Perfect! You've learned the main semantic layout tags. Let's look at inline containers."
        },
        // --- NEWLY ADDED HTML LESSONS ---
        {
            story: "We've used <code>&lt;div&gt;</code>, which is a 'block' container. Its inline partner is <code>&lt;span&gt;</code>. It's used to wrap small parts of text *inside* a line, often for styling. Add a <code>&lt;span&gt;</code> around the word 'fun' in a paragraph.",
            objective: "Use a <span> tag.",
            file: "index.html",
            hint: "Write this: <code>&lt;p&gt;HTML is &lt;span&gt;fun!&lt;/span&gt;&lt;/p&gt;</code>",
            solution: /<p>\s*HTML is <span>\s*fun!\s*<\/span>\s*<\/p>/i,
            fullAnswer: "<p>HTML is <span>fun!</span></p>",
            preview: true,
            successMessage: "Great! Like <code>&lt;div&gt;</code>, this tag is most powerful when combined with CSS."
        },
        {
            story: "Let's add a comment. Comments are notes for developers that the browser *ignores*. They are essential for leaving notes in your code. They look like this: <code>&lt;!-- Your note --&gt;</code>.",
            objective: "Write an HTML comment.",
            file: "index.html",
            hint: "Add a comment that says: <code>&lt;!-- This is my first webpage --&gt;</code>",
            solution: /<!--\s*This is my first webpage\s*-->/i,
            fullAnswer: "<!-- This is my first webpage -->",
            preview: false,
            successMessage: "Nice! Use comments to organize your code. Now let's upgrade our form."
        },
        {
            story: "Our <code>&lt;input&gt;</code> is for a single line. For a multi-line 'message' box, we use <code>&lt;textarea&gt;&lt;/textarea&gt;</code>. Let's add one to our form, linked to a label.",
            objective: "Add a <textarea>.",
            file: "index.html",
            hint: "Add this to your form: <code>&lt;label for=\"msg\"&gt;Message:&lt;/label&gt;&lt;textarea id=\"msg\"&gt;&lt;/textarea&gt;</code>",
            solution: /<form>(.|\n)*<label\s+for=['"]msg['"]\s*>\s*Message:\s*<\/label>\s*<textarea\s+id=['"]msg['"]\s*>\s*<\/textarea>(.|\n)*<\/form>/i,
            fullAnswer: "<form>\n  ...\n  <label for=\"msg\">Message:</label>\n  <textarea id=\"msg\"></textarea>\n</form>",
            preview: true,
            successMessage: "Perfect! Now the user can write a long message. What about options?"
        },
        {
            story: "For 'check all that apply' options, we use <code>&lt;input type=\"checkbox\"&gt;</code>. Let's add a checkbox asking 'Sign up for newsletter?' (Don't forget the label!).",
            objective: "Add a checkbox input.",
            file: "index.html",
            hint: "Add this to your form: <code>&lt;label&gt;&lt;input type=\"checkbox\"&gt; Sign up?&lt;/label&gt;</code>",
            solution: /<form>(.|\n)*<label>\s*<input\s+type=['"]checkbox['"]\s*>\s*Sign up\?\s*<\/label>(.|\n)*<\/form>/i,
            fullAnswer: "<form>\n  ...\n  <label><input type=\"checkbox\"> Sign up?</label>\n</form>",
            preview: true,
            successMessage: "Great! Checkboxes let you pick multiple. What if you can only pick one?"
        },
        {
            story: "For 'pick only one' options, we use <code>&lt;input type=\"radio\"&gt;</code>. The magic is the <code>name</code> attribute: all radio buttons with the *same name* are in a group. Let's add two options for 'Team' (named 'team').",
            objective: "Add radio buttons.",
            file: "index.html",
            hint: "Add: <code>&lt;label&gt;&lt;input type=\"radio\" name=\"team\"&gt;Red&lt;/label&gt; &lt;label&gt;&lt;input type=\"radio\" name=\"team\"&gt;Blue&lt;/label&gt;</code>",
            solution: /<input\s+type=['"]radio['"]\s+name=['"]team['"](.|\n)*<input\s+type=['"]radio['"]\s+name=['"]team['"]/i,
            fullAnswer: "<label><input type=\"radio\" name=\"team\" value=\"red\"> Red</label>\n<label><input type=\"radio\" name=\"team\" value=\"blue\"> Blue</label>",
            preview: true,
            successMessage: "See? You can only select one at a time. Now for dropdowns."
        },
        {
            story: "A dropdown list is made with <code>&lt;select&gt;</code>, and each choice is an <code>&lt;option&gt;</code>. Let's make a dropdown to 'Choose a pet' with options for 'Dog' and 'Cat'.",
            objective: "Create a <select> list.",
            file: "index.html",
            hint: "Use <code>&lt;select&gt;&lt;option value=\"dog\"&gt;Dog&lt;/option&gt;&lt;option value=\"cat\"&gt;Cat&lt;/option&gt;&lt;/select&gt;</code>",
            solution: /<select>\s*<option\s+value=['"]dog['"]\s*>\s*Dog\s*<\/option>\s*<option\s+value=['"]cat['"]\s*>\s*Cat\s*<\/option>\s*<\/select>/i,
            fullAnswer: "<select>\n  <option value=\"dog\">Dog</option>\n  <option value=\"cat\">Cat</option>\n</select>",
            preview: true,
            successMessage: "Bleep! You've mastered all the main form elements. Let's learn to show data in a table."
        },
        {
            story: "Tables are for grid data. You use <code>&lt;table&gt;</code> (wrapper), <code>&lt;tr&gt;</code> (table row), and <code>&lt;td&gt;</code> (table data/cell). Let's make a 2x2 table.",
            objective: "Create a simple <table>.",
            file: "index.html",
            hint: "<code>&lt;table&gt;&lt;tr&gt;&lt;td&gt;Cell 1&lt;/td&gt;&lt;td&gt;Cell 2&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Cell 3&lt;/td&gt;&lt;td&gt;Cell 4&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;</code>",
            solution: /<table>\s*<tr>\s*<td>(.|\n)*<\/td>\s*<td>(.|\n)*<\/td>\s*<\/tr>\s*<tr>\s*<td>(.|\n)*<\/td>\s*<td>(.|\n)*<\/td>\s*<\/tr>\s*<\/table>/i,
            fullAnswer: "<table>\n  <tr>\n    <td>Cell 1</td>\n    <td>Cell 2</td>\n  </tr>\n  <tr>\n    <td>Cell 3</td>\n    <td>Cell 4</td>\n  </tr>\n</table>",
            preview: true,
            successMessage: "Great! Tables are perfect for structured data. You can also add <code>&lt;th&gt;</code> for table headers. Now let's add some media."
        },
        {
            story: "You can embed videos with the <code>&lt;video&gt;</code> tag. It's best to add <code>controls</code> so the user can play/pause. Let's add a placeholder video (it won't really play, but the tag is correct).",
            objective: "Embed a <video>.",
            file: "index.html",
            hint: "<code>&lt;video controls width=\"300\"&gt;&lt;source src=\"movie.mp4\" type=\"video/mp4\"&gt;&lt;/video&gt;</code>",
            solution: /<video\s+controls/i,
            fullAnswer: "<video controls width=\"300\">\n  <source src=\"movie.mp4\" type=\"video/mp4\">\n  Your browser does not support the video tag.\n</video>",
            preview: true,
            successMessage: "Awesome! You can also embed audio."
        },
        {
            story: "The <code>&lt;audio&gt;</code> tag is just like video, but for sound. It also needs <code>controls</code>. Let's add one.",
            objective: "Embed an <audio> tag.",
            file: "index.html",
            hint: "<code>&lt;audio controls&gt;&lt;source src=\"sound.mp3\" type=\"audio/mpeg\"&gt;&lt;/audio&gt;</code>",
            solution: /<audio\s+controls/i,
            fullAnswer: "<audio controls>\n  <source src=\"sound.mp3\" type=\"audio/mpeg\">\n  Your browser does not support the audio tag.\n</audio>",
            preview: true,
            successMessage: "Bleep! Now you can handle multimedia. One last topic: iframes."
        },
        {
            story: "An <code>&lt;iframe&gt;</code> lets you embed *another webpage* inside your page. Let's embed a 300x200 placeholder page.",
            objective: "Use an <iframe>.",
            file: "index.html",
            hint: "<code>&lt;iframe src=\"https://placehold.co/300x200\" width=\"300\" height=\"200\"&gt;&lt;/iframe&gt;</code>",
            solution: /<iframe\s+src=['"]https:\/\/placehold.co\/300x200['"]/i,
            fullAnswer: "<iframe src=\"https://placehold.co/300x200\" width=\"300\" height=\"200\"></iframe>",
            preview: true,
            successMessage: "Bzzzt! You've embedded a whole other page. That's a huge set of skills!"
        },
        {
            story: "Bleep bloop! You've completed the entire HTML track, from basic tags and forms to semantic layout and media. You have all the building blocks to create any webpage you can imagine. Bzzzt! Well done!",
            objective: "You've completed the HTML track!",
            file: "index.html",
            hint: "There's no code! Just click 'Back to Hub' or 'Restart Track'",
            solution: /^Congratulations!$/i,
            fullAnswer: "Congratulations!",
            preview: false,
            successMessage: "Congratulations on mastering HTML!"
        }
    ];

    const cssLessons = [
        {
            story: "Bleep bloop! Welcome to the CSS track. CSS (Cascading Style Sheets) is what gives HTML its looks! Let's start by changing the color of our <code>&lt;h1&gt;</code> tag. Type 'ready' to begin!",
            objective: "Learn what CSS is.",
            file: "style.css",
            hint: "Just type 'ready' in the terminal!",
            solution: "ready",
            preview: false,
            baseHtml: "<h1>My First Webpage</h1><p>This is a paragraph.</p>",
            successMessage: "Great! Let's write our first CSS rule."
        },
        {
            story: "In CSS, we write 'rules'. A rule has two parts: a 'selector' (what to style) and 'declarations' (how to style it). To style all <code>&lt;h1&gt;</code> tags, our selector is just <code>h1</code>. Then we use curly braces <code>{ }</code>. Try making an empty rule for <code>h1</code>.",
            objective: "Create an empty CSS rule for h1.",
            file: "style.css",
            hint: "The syntax is: <code>selector { }</code>. Your selector is <code>h1</code>.",
            solution: /h1\s*\{\s*\}/i,
            fullAnswer: "h1 { }",
            preview: false,
            baseHtml: "<h1>My First Webpage</h1><p>This is a paragraph.</p>",
            successMessage: "Perfect! You've 'selected' the h1. Now let's add a declaration."
        },
        {
            story: "Inside the <code>{ }</code>, we add declarations. A declaration is a 'property' and a 'value', separated by a colon (<code>:</code>) and ending with a semicolon (<code>;</code>). To change the text color, we use the <code>color</code> property. Let's make our <code>h1</code> tag the color <code>blue</code>.",
            objective: "Change the h1 color to blue.",
            file: "style.css",
            hint: "The syntax is: <code>h1 { property: value; }</code>. Use <code>color: blue;</code>",
            solution: /h1\s*\{\s*color\s*:\s*blue\s*;\s*\}/i,
            fullAnswer: "h1 { color: blue; }",
            preview: true,
            baseHtml: "<h1>My First Webpage</h1><p>This is a paragraph.</p>",
            successMessage: "Bleep! Look at that! The preview updated and your text is blue. Let's style the paragraph."
        },
        {
            story: "Now, let's select the <code>&lt;p&gt;</code> tag and change its <code>font-size</code> property. Let's set it to <code>20px</code> (20 pixels).",
            objective: "Change the p font-size to 20px.",
            file: "style.css",
            hint: "Create a new rule for <code>p</code>. Use <code>font-size: 20px;</code>",
            solution: /p\s*\{\s*font-size\s*:\s*20px\s*;\s*\}/i,
            fullAnswer: "p { font-size: 20px; }",
            preview: true,
            baseHtml: "<h1>My First Webpage</h1><p>This is a paragraph.</p>",
            successMessage: "Great! The paragraph text is much bigger. But what if we only want to style *one* paragraph?"
        },
        {
            story: "For that, we use a 'class'. In our HTML, we have <code>&lt;p class=\"special\"&gt;</code>. To select *only* this, our selector starts with a dot: <code>.special</code>. Let's make the text with the 'special' class have a <code>background-color</code> of <code>yellow</code>.",
            objective: "Style a class named 'special'.",
            file: "style.css",
            hint: "Your selector is <code>.special</code>. The property is <code>background-color: yellow;</code>",
            solution: /\.special\s*\{\s*background-color\s*:\s*yellow\s*;\s*\}/i,
            fullAnswer: ".special { background-color: yellow; }",
            preview: true,
            baseHtml: "<h1>My First Webpage</h1><p>This is a paragraph.</p><p class=\"special\">This one is special!</p>",
            successMessage: "Bzzzt! Awesome! You're a CSS wizard."
        },
        // --- NEW CSS LESSONS START HERE ---
        {
            story: "Let's talk about the 'Box Model'. Every element is a box. We know <code>padding</code> is the space *inside* the border. <code>margin</code> is the space *outside* the border. Let's add <code>margin: 20px;</code> to our <code>h1</code>.",
            objective: "Add 'margin' to the h1.",
            file: "style.css",
            hint: "Add <code>margin: 20px;</code> to your existing <code>h1</code> rule.",
            solution: /h1\s*\{(?=.*color\s*:\s*blue\s*;)(?=.*margin\s*:\s*20px\s*;).*\}/is,
            fullAnswer: "h1 {\n  color: blue;\n  margin: 20px;\n}",
            preview: true,
            baseHtml: "<h1>My First Webpage</h1><p>This is a paragraph.</p>",
            successMessage: "See that? The <code>h1</code> pushed away from the <code>p</code> tag. That's margin!"
        },
        {
            story: "We can also set a <code>width</code>. Let's make our 'special' paragraph take up only <code>300px</code> of width.",
            objective: "Set the 'width' of the '.special' class.",
            file: "style.css",
            hint: "Add <code>width: 300px;</code> to your existing <code>.special</code> rule.",
            solution: /\.special\s*\{(?=.*background-color\s*:\s*yellow\s*;)(?=.*width\s*:\s*300px\s*;).*\}/is,
            fullAnswer: ".special {\n  background-color: yellow;\n  width: 300px;\n}",
            preview: true,
            baseHtml: "<h1>My First Webpage</h1><p>This is a paragraph.</p><p class=\"special\">This one is special! Notice how this text now wraps because the box is narrower.</p>",
            successMessage: "Bloop! See how the text wraps? The box is now a fixed width."
        },
        {
            story: "Tags have a default <code>display</code> type. <code>&lt;h1&gt;</code> and <code>&lt;p&gt;</code> are <code>display: block</code> (they take up their own line). <code>&lt;a&gt;</code> and <code>&lt;span&gt;</code> are <code>display: inline</code> (they flow with text). Let's make our paragraph <code>display: inline</code>.",
            objective: "Change the 'display' property of <p>.",
            file: "style.css",
            hint: "Add <code>display: inline;</code> to your <code>p</code> rule.",
            solution: /p\s*\{(?=.*font-size\s*:\s*20px\s*;)(?=.*display\s*:\s*inline\s*;).*\}/is,
            fullAnswer: "p {\n  font-size: 20px;\n  display: inline;\n}",
            preview: true,
            baseHtml: "<h1>My First Webpage</h1><p>This is a paragraph.</p><p class=\"special\">This one is special!</p>",
            successMessage: "Whoa! See how they all scrunched up onto one line? That's the power of 'display'."
        },
        {
            story: "We used a <code>class</code> selector (<code>.special</code>). To select a unique <code>id</code> (like <code>&lt;h1 id=\"main-title\"&gt;</code>), we use a hash (<code>#</code>). Let's select <code>#main-title</code> and give it a <code>border-bottom</code> of <code>2px solid white</code>.",
            objective: "Style an 'id' selector.",
            file: "style.css",
            hint: "Create a new rule: <code>#main-title { border-bottom: 2px solid white; }</code>",
            solution: /#main-title\s*\{\s*border-bottom\s*:\s*2px\s+solid\s+white\s*;\s*\}/i,
            fullAnswer: "#main-title {\n  border-bottom: 2px solid white;\n}",
            preview: true,
            baseHtml: "<h1 id=\"main-title\">My First Webpage</h1><p>This is a paragraph.</p>",
            successMessage: "Bzzzt! That looks sharp. ID selectors are very powerful (and specific!)."
        },
        {
            story: "You can also select tags *inside* other tags. This is a 'descendant selector'. To style only paragraphs *inside* an <code>&lt;article&gt;</code> tag, we'd use <code>article p</code>. Let's make all <code>&lt;li&gt;</code> tags inside a <code>&lt;ul&gt;</code> have <code>color: cyan;</code>.",
            objective: "Use a 'descendant selector'.",
            file: "style.css",
            hint: "Create a new rule: <code>ul li { color: cyan; }</code>",
            solution: /ul\s+li\s*\{\s*color\s*:\s*cyan\s*;\s*\}/i,
            fullAnswer: "ul li { color: cyan; }",
            preview: true,
            baseHtml: "<ul><li>Item 1</li><li>Item 2</li></ul><ol><li>Item 3</li></ol>",
            successMessage: "See? Only 'Item 1' and 'Item 2' changed color. The <code>&lt;ol&gt;</code> list was not affected!"
        },
        {
            story: "Let's make our link interactive! We can use a 'pseudo-class' to style it *when you hover* over it. The selector is <code>a:hover</code>. Let's make our link turn <code>yellow</code> on hover.",
            objective: "Use the ':hover' pseudo-class.",
            file: "style.css",
            hint: "Create a new rule: <code>a:hover { color: yellow; }</code>",
            solution: /a:hover\s*\{\s*color\s*:\s*yellow\s*;\s*\}/i,
            fullAnswer: "a:hover { color: yellow; }",
            preview: true,
            baseHtml: "<a href=\"#\">Hover over me!</a>",
            successMessage: "Bleep! Now hover over the link in the preview. It changes! That's interactive CSS."
        },
        {
            story: "Let's add a few more text styles. We can make text bold with <code>font-weight: bold;</code>. Let's make our <code>.special</code> paragraph bold.",
            objective: "Use 'font-weight'.",
            file: "style.css",
            hint: "Add <code>font-weight: bold;</code> to your <code>.special</code> rule.",
            solution: /\.special\s*\{(?=.*background-color\s*:\s*yellow\s*;)(?=.*font-weight\s*:\s*bold\s*;).*\}/is,
            fullAnswer: ".special {\n  background-color: yellow;\n  width: 300px;\n  font-weight: bold;\n}",
            preview: true,
            baseHtml: "<p class=\"special\">This text is now bold and yellow.</p>",
            successMessage: "Great! And to center text, we use <code>text-align: center;</code>. Let's center our <code>h1</code>.",
        },
        {
            story: "Let's center our <code>h1</code> using <code>text-align: center;</code>.",
            objective: "Use 'text-align'.",
            file: "style.css",
            hint: "Add <code>text-align: center;</code> to your <code>h1</code> rule.",
            solution: /h1\s*\{(?=.*color\s*:\s*blue\s*;)(?=.*text-align\s*:\s*center\s*;).*\}/is,
            fullAnswer: "h1 {\n  color: blue;\n  margin: 20px;\n  text-align: center;\n}",
            preview: true,
            baseHtml: "<h1>This is centered</h1>",
            successMessage: "Bzzzt! You've learned a ton of CSS basics. Now let's get into layout!"
        },
        // --- NEWLY ADDED CSS LESSONS ---
        {
            story: "We've set <code>width</code>, but you can also set <code>height</code>. Let's make our <code>.special</code> box a square. Add <code>height: 300px;</code> to its rule.",
            objective: "Set the 'height' of an element.",
            file: "style.css",
            hint: "Add <code>height: 300px;</code> to your <code>.special</code> rule.",
            solution: /\.special\s*\{(?=.*width\s*:\s*300px\s*;)(?=.*height\s*:\s*300px\s*;).*\}/is,
            fullAnswer: ".special {\n  /* ...other rules... */\n  width: 300px;\n  height: 300px;\n}",
            preview: true,
            baseHtml: "<p class=\"special\">This box is now 300x300.</p>",
            successMessage: "Bleep! A perfect square. But what if the content is *too big*? We can use <code>max-width</code>."
        },
        {
            story: "<code>max-width: 500px;</code> means 'be 100% width *until* you hit 500px, then stop growing'. This is great for responsive design. Let's change our <code>.special</code> rule to use <code>max-width: 500px;</code> instead of <code>width</code>.",
            objective: "Use 'max-width'.",
            file: "style.css",
            hint: "Replace <code>width: 300px;</code> with <code>max-width: 500px;</code> in your <code>.special</code> rule.",
            solution: /\.special\s*\{(?=.*background-color\s*:\s*yellow\s*;)(?=.*max-width\s*:\s*500px\s*;).*\}/is,
            fullAnswer: ".special {\n  background-color: yellow;\n  max-width: 500px;\n  /* ...other rules... */\n}",
            preview: true,
            baseHtml: "<p class=\"special\">This container won't get wider than 500px.</p>",
            successMessage: "Great! Now let's learn about <code>box-sizing</code>. This one is important!"
        },
        {
            story: "By default, <code>padding</code> and <code>border</code> are *added* to the <code>width</code>. This is annoying. <code>box-sizing: border-box;</code> *includes* them in the <code>width</code>. Let's add <code>padding: 20px;</code> and <code>box-sizing: border-box;</code> to our <code>.special</code> rule.",
            objective: "Use 'box-sizing: border-box'.",
            file: "style.css",
            hint: "Add <code>padding: 20px;</code> and <code>box-sizing: border-box;</code> to the <code>.special</code> rule.",
            solution: /\.special\s*\{(?=.*max-width\s*:\s*500px\s*;)(?=.*padding\s*:\s*20px\s*;)(?=.*box-sizing\s*:\s*border-box\s*;).*\}/is,
            fullAnswer: ".special {\n  max-width: 500px;\n  padding: 20px;\n  box-sizing: border-box;\n  /* ...other rules... */\n}",
            preview: true,
            baseHtml: "<p class=\"special\">This container is still 500px wide, even with padding!</p>",
            successMessage: "See? The box didn't get wider! Many developers set this on all elements. Now for positioning."
        },
        {
            story: "Time for <code>position</code>! The default is <code>static</code>. <code>position: relative;</code> lets you 'nudge' an element with <code>top</code>, <code>left</code>, <code>bottom</code>, <code>right</code>. Let's add <code>position: relative;</code> and <code>left: 30px;</code> to our <code>h1</code>.",
            objective: "Use 'position: relative'.",
            file: "style.css",
            hint: "Add <code>position: relative;</code> and <code>left: 30px;</code> to your <code>h1</code> rule.",
            solution: /h1\s*\{(?=.*color\s*:\s*blue\s*;)(?=.*position\s*:\s*relative\s*;)(?=.*left\s*:\s*30px\s*;).*\}/is,
            fullAnswer: "h1 {\n  color: blue;\n  position: relative;\n  left: 30px;\n  /* ...other rules... */\n}",
            preview: true,
            baseHtml: "<h1>I'm nudged 30px to the right!</h1>",
            successMessage: "Bleep! See how it moved? Now for <code>absolute</code> positioning."
        },
        {
            story: "<code>position: absolute;</code> takes an element *out* of the normal flow and positions it relative to its *nearest positioned ancestor*. Let's make a <code>.box</code> absolute.",
            objective: "Use 'position: absolute'.",
            file: "style.css",
            hint: "Create a rule: <code>.box { position: absolute; top: 10px; right: 10px; background-color: red; }</code>",
            solution: /\.box\s*\{\s*position\s*:\s*absolute\s*;\s*top\s*:\s*10px\s*;\s*right\s*:\s*10px\s*;\s*background-color\s*:\s*red\s*;\s*\}/i,
            fullAnswer: ".box {\n  position: absolute;\n  top: 10px;\n  right: 10px;\n  background-color: red;\n}",
            preview: true,
            baseHtml: "<p>Some text.</p><div class=\"box\">I'm in the corner!</div><p>More text.</p>",
            successMessage: "See? It's in the corner of the *preview window* (its nearest positioned ancestor)!"
        },
        {
            story: "<code>position: fixed;</code> is like <code>absolute</code>, but positions relative to the *viewport* (the browser window). It 'sticks' even when you scroll. Let's make a <code>.cookie-banner</code> fixed to the bottom.",
            objective: "Use 'position: fixed'.",
            file: "style.css",
            hint: "<code>.cookie-banner { position: fixed; bottom: 0; left: 0; width: 100%; background-color: #333; color: white; padding: 10px; }</code>",
            solution: /\.cookie-banner\s*\{\s*position\s*:\s*fixed\s*;\s*bottom\s*:\s*0\s*;\s*left\s*:\s*0\s*;\s*width\s*:\s*100%\s*;\s*background-color\s*:\s*#333\s*;\s*color\s*:\s*white\s*;\s*padding\s*:\s*10px\s*;\s*\}/i,
            fullAnswer: ".cookie-banner {\n  position: fixed;\n  bottom: 0;\n  left: 0;\n  width: 100%;\n  background-color: #333;\n  color: white;\n  padding: 10px;\n}",
            preview: true,
            baseHtml: "<div class=\"cookie-banner\">This is a cookie banner. It sticks!</div><div style=\"height:1000px\">Scrollable content...</div>",
            successMessage: "Bzzzt! It's stuck to the bottom. Now let's style the forms from our HTML track."
        },
        {
            story: "Let's style our form elements. Target <code>input, textarea, select</code>. Let's give them <code>width: 100%;</code>, <code>padding: 8px;</code>, and <code>margin-bottom: 10px;</code> to make them look nice.",
            objective: "Style <input>, <textarea>, and <select>.",
            file: "style.css",
            hint: "Create one rule for all three: <code>input, textarea, select { ... }</code>",
            solution: /input\s*,\s*textarea\s*,\s*select\s*\{\s*width\s*:\s*100%\s*;\s*padding\s*:\s*8px\s*;\s*margin-bottom\s*:\s*10px\s*;\s*\}/i,
            fullAnswer: "input, textarea, select {\n  width: 100%;\n  padding: 8px;\n  margin-bottom: 10px;\n}",
            preview: true,
            baseHtml: "<form><label>Name:</label><input><label>Message:</label><textarea></textarea><label>Pet:</label><select><option>Dog</option></select></form>",
            successMessage: "Bloop! Much cleaner. Now let's style the <code>&lt;button&gt;</code>."
        },
        {
            story: "Let's make our <code>&lt;button&gt;</code> look good. Give it a <code>background-color: green;</code>, <code>color: white;</code>, <code>padding: 10px 15px;</code>, a <code>border: none;</code>, and <code>cursor: pointer;</code>.",
            objective: "Style a <button>.",
            file: "style.css",
            hint: "Create a <code>button { ... }</code> rule with those properties.",
            solution: /button\s*\{\s*background-color\s*:\s*green\s*;\s*color\s*:\s*white\s*;\s*padding\s*:\s*10px\s+15px\s*;\s*border\s*:\s*none\s*;\s*cursor\s*:\s*pointer\s*;\s*\}/i,
            fullAnswer: "button {\n  background-color: green;\n  color: white;\n  padding: 10px 15px;\n  border: none;\n  cursor: pointer;\n}",
            preview: true,
            baseHtml: "<button>Click Me</button>",
            successMessage: "That's a nice-looking button! Now let's style the <code>&lt;table&gt;</code>."
        },
        {
            story: "Tables need styling. Let's start by making the <code>&lt;table&gt;</code> take up <code>width: 100%;</code> and add <code>border-collapse: collapse;</code> (this merges cell borders).",
            objective: "Style a <table>.",
            file: "style.css",
            hint: "Create a rule: <code>table { width: 100%; border-collapse: collapse; }</code>",
            solution: /table\s*\{\s*width\s*:\s*100%\s*;\s*border-collapse\s*:\s*collapse\s*;\s*\}/i,
            fullAnswer: "table {\n  width: 100%;\n  border-collapse: collapse;\n}",
            preview: true,
            baseHtml: "<table><tr><td>Cell 1</td><td>Cell 2</td></tr><tr><td>Cell 3</td><td>Cell 4</td></tr></table>",
            successMessage: "Good. Now let's add borders to the cells."
        },
        {
            story: "Now target <code>th, td</code> (Table Header and Table Data cells). Give them a <code>border: 1px solid #ddd;</code> and <code>padding: 8px;</code>.",
            objective: "Style <th> and <td> cells.",
            file: "style.css",
            hint: "Create a rule: <code>th, td { border: 1px solid #ddd; padding: 8px; }</code>",
            solution: /th\s*,\s*td\s*\{\s*border\s*:\s*1px\s+solid\s+#ddd\s*;\s*padding\s*:\s*8px\s*;\s*\}/i,
            fullAnswer: "th, td {\n  border: 1px solid #ddd;\n  padding: 8px;\n}",
            preview: true,
            baseHtml: "<table style=\"width:100%; border-collapse:collapse;\"><tr><th>Name</th><th>Role</th></tr><tr><td>Eva</td><td>Navigator</td></tr></table>",
            successMessage: "That looks like a proper table! Let's add one more trick: zebra stripes."
        },
        {
            story: "We can style *every other* row using <code>tr:nth-child(even)</code>. Let's give every even table row a <code>background-color: #f2f2f2;</code>.",
            objective: "Use 'nth-child' for zebra striping.",
            file: "style.css",
            hint: "Create a rule: <code>tr:nth-child(even) { background-color: #f2f2f2; }</code>",
            solution: /tr:nth-child\(even\)\s*\{\s*background-color\s*:\s*#f2f2f2\s*;\s*\}/i,
            fullAnswer: "tr:nth-child(even) { background-color: #f2f2f2; }",
            preview: true,
            baseHtml: "<style>table{width:100%; border-collapse:collapse;} th,td{border:1px solid #ddd; padding:8px;}</style><table><tr><th>Name</th><th>Role</th></tr><tr><td>Eva</td><td>Navigator</td></tr><tr><td>Ben</td><td>Engineer</td></tr><tr><td>Aris</td><td>Medic</td></tr></table>",
            successMessage: "Bzzzt! How cool is that? Now let's learn the most important layout tool: Flexbox."
        },
        {
            story: "Flexbox! This is for 1D layouts. Add <code>display: flex;</code> to a container (<code>.container</code>) to make its children (<code>.box</code>) line up in a row.",
            objective: "Use 'display: flex'.",
            file: "style.css",
            hint: "Create a rule: <code>.container { display: flex; }</code>",
            solution: /\.container\s*\{\s*display\s*:\s*flex\s*;\s*\}/i,
            fullAnswer: ".container { display: flex; }",
            preview: true,
            baseHtml: "<div class=\"container\"><div class=\"box\" style=\"padding:20px; background-color: #f0a;\">Box 1</div><div class=\"box\" style=\"padding:20px; background-color: #0fa;\">Box 2</div></div>",
            successMessage: "Bloop! They're in a row. Just like that! Now let's align them."
        },
        {
            story: "<code>justify-content</code> aligns items along the main (horizontal) axis. Let's add <code>justify-content: space-between;</code> to our <code>.container</code> to spread them out.",
            objective: "Use 'justify-content'.",
            file: "style.css",
            hint: "Add <code>justify-content: space-between;</code> to your <code>.container</code> rule.",
            solution: /\.container\s*\{(?=.*display\s*:\s*flex\s*;)(?=.*justify-content\s*:\s*space-between\s*;).*\}/is,
            fullAnswer: ".container {\n  display: flex;\n  justify-content: space-between;\n}",
            preview: true,
            baseHtml: "<div class=\"container\" style=\"border: 1px solid white;\"><div class=\"box\" style=\"padding:20px; background-color: #f0a;\">Box 1</div><div class=\"box\" style=\"padding:20px; background-color: #0fa;\">Box 2</div></div>",
            successMessage: "See? One is on the left, one on the right. Now for vertical alignment."
        },
        {
            story: "<code>align-items</code> aligns items along the cross (vertical) axis. Let's add <code>align-items: center;</code> to our <code>.container</code>.",
            objective: "Use 'align-items'.",
            file: "style.css",
            hint: "Add <code>align-items: center;</code> to your <code>.container</code> rule.",
            solution: /\.container\s*\{(?=.*display\s*:\s*flex\s*;)(?=.*align-items\s*:\s*center\s*;).*\}/is,
            fullAnswer: ".container {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n}",
            preview: true,
            baseHtml: "<div class=\"container\" style=\"border: 1px solid white; height: 150px;\"><div class=\"box\" style=\"padding:20px; background-color: #f0a;\">Box 1</div><div class=\"box\" style=\"padding:20px; background-color: #0fa;\">Box 2</div></div>",
            successMessage: "Perfectly centered! Flexbox is amazing. Now for its 2D cousin: CSS Grid."
        },
        {
            story: "CSS Grid is for 2D layouts. Start with <code>display: grid;</code>. Then, define columns with <code>grid-template-columns</code>. <code>1fr 1fr</code> means 'two columns of one equal fraction each'.",
            objective: "Use 'display: grid'.",
            file: "style.css",
            hint: "<code>.grid-container { display: grid; grid-template-columns: 1fr 1fr; }</code>",
            solution: /\.grid-container\s*\{\s*display\s*:\s*grid\s*;\s*grid-template-columns\s*:\s*1fr\s+1fr\s*;\s*\}/i,
            fullAnswer: ".grid-container {\n  display: grid;\n  grid-template-columns: 1fr 1fr;\n}",
            preview: true,
            baseHtml: "<div class=\"grid-container\"><div class=\"item\" style=\"border: 1px solid #f0a;\">Item 1</div><div class=\"item\" style=\"border: 1px solid #0fa;\">Item 2</div><div class=\"item\" style=\"border: 1px solid #0af;\">Item 3</div></div>",
            successMessage: "Bzzzt! You've got a 2-column grid. Let's add some polish with transitions."
        },
        {
            story: "We can make <code>:hover</code> effects smooth with <code>transition</code>. Let's make our button change color smoothly. Add <code>transition: background-color 0.3s;</code> to your <code>button</code> rule.",
            objective: "Use 'transition'.",
            file: "style.css",
            hint: "Add <code>transition: background-color 0.3s;</code> to your <code>button</code> rule. Then add a <code>button:hover { background-color: darkgreen; }</code> rule.",
            // Updated Regex to be more flexible with whitespace and comments
            solution: /button\s*\{[^{}]*background-color\s*:\s*green\s*;[^{}]*transition\s*:\s*background-color\s+0\.3s\s*;[^{}]*\}\s*button:hover\s*\{\s*background-color\s*:\s*darkgreen\s*;\s*\}/is,
            fullAnswer: "button {\n  background-color: green;\n  /* ...other rules... */\n  transition: background-color 0.3s;\n}\nbutton:hover {\n  background-color: darkgreen;\n}",
            preview: true,
            baseHtml: "<button>Hover over me!</button>",
            successMessage: "Now hover over it. See how it fades? So smooth! Let's do a <code>transform</code>."
        },
        {
            story: "<code>transform</code> lets you move, scale, and rotate elements. Let's make our button *rotate* on hover. Add <code>transition: transform 0.3s;</code> to the <code>button</code> and <code>transform: rotate(5deg);</code> to the <code>button:hover</code>.",
            objective: "Use 'transform' and 'transition'.",
            file: "style.css",
            hint: "Add <code>transition: transform 0.3s;</code> to <code>button</code>. Add <code>transform: rotate(5deg);</code> to <code>button:hover</code>.",
            solution: /button\s*\{[^{}]*transition\s*:\s*transform\s+0\.3s\s*;[^{}]*\}\s*button:hover\s*\{[^{}]*transform\s*:\s*rotate\(5deg\)\s*;[^{}]*\}/is,
            fullAnswer: "button {\n  /* ...other rules... */\n  transition: transform 0.3s;\n}\nbutton:hover {\n  background-color: darkgreen;\n  transform: rotate(5deg);\n}",
            preview: true,
            baseHtml: "<button>Hover over me!</button>",
            successMessage: "Bleep! A wobbly button! You're an animator! One last lesson: Media Queries."
        },
        {
            story: "Media Queries make your site *responsive*. They let you apply styles *only* on certain screen sizes. Let's make the <code>body</code> background <code>blue</code> *only* if the screen is 600px wide or less.",
            objective: "Write a Media Query.",
            file: "style.css",
            hint: "<code>@media (max-width: 600px) { body { background-color: blue; } }</code>",
            solution: /@media\s*\(max-width\s*:\s*600px\)\s*\{\s*body\s*\{\s*background-color\s*:\s*blue\s*;\s*\}\s*\}/i,
            fullAnswer: "@media (max-width: 600px) {\n  body {\n    background-color: blue;\n  }\n}",
            preview: true,
            baseHtml: "<p>Try resizing the preview window (if you can). If it's narrow, the background will turn blue.</p>",
            successMessage: "Bzzzt! That's the key to responsive design. You've completed the CSS track!"
        },
        {
            story: "Bleep bloop! You've completed the entire CSS track, from basic selectors and colors to advanced layout with Flexbox, Grid, and even responsive design. You have all the styling tools you need. Bzzzt! Well done!",
            objective: "You've completed the CSS track!",
            file: "style.css",
            hint: "There's no code! Just click 'Back to Hub' or 'Restart Track'",
            solution: /^Congratulations!$/i,
            fullAnswer: "Congratulations!",
            preview: false,
            successMessage: "Congratulations on mastering CSS!"
        }
    ];

const combinedLessons = [
    {
        story: "Bloop! Welcome to the combined track. You'll use both HTML and CSS! First, let's create the HTML structure for a simple profile card. Add an <code>&lt;h2&gt;</code> with your name and a <code>&lt;p&gt;</code> with a short bio.",
        objective: "Create the HTML for a profile card.",
        file: "index.html",
        hint: "Just add an <h2>...</h2> tag and a <p>...</p> tag.",
        solution: /<h2>.+<\/h2>\s*<p>.+<\/p>/is, // Added 's' flag for multiline
        fullAnswer: "<h2>Browser Bot</h2>\n<p>Your friendly web guide.</p>",
        preview: true,
        baseHtml: "", // Starts empty
        successMessage: "Great structure! But it looks a bit plain, doesn't it? Let's switch to CSS."
    },
    {
        story: "Time for style! Our HTML is inside a <code>&lt;div&gt;</code> with a class of <code>profile-card</code>. Let's select <code>.profile-card</code> and give it a <code>border</code>. The value <code>1px solid gray</code> will do.",
        objective: "Add a border to the profile card.",
        file: "style.css",
        hint: "Use <code>.profile-card { border: 1px solid gray; }</code>",
        solution: /\.profile-card\s*\{\s*border\s*:\s*1px\s+solid\s+gray\s*;\s*\}/i,
        fullAnswer: ".profile-card { border: 1px solid gray; }",
        preview: true,
        baseHtml: "<div class=\"profile-card\"><h2>Browser Bot</h2>\n<p>Your friendly web guide.</p></div>", // Base HTML for this step
        successMessage: "Nice! Now it has a border. Let's add some padding."
    },
    {
        story: "The text is too close to the border. Let's add some 'breathing room' inside the border. This is called <code>padding</code>. Add <code>padding: 16px;</code> to your <code>.profile-card</code> rule.",
        objective: "Add padding to the profile card.",
        file: "style.css",
        hint: "Add <code>padding: 16px;</code> inside the existing <code>.profile-card</code> braces.",
        solution: /\.profile-card\s*\{(?=.*border\s*:[^;]+;)(?=.*padding\s*:\s*16px\s*;).*\}/is,
        fullAnswer: ".profile-card {\n  border: 1px solid gray;\n  padding: 16px;\n}",
        preview: true,
        baseHtml: "<div class=\"profile-card\"><h2>Browser Bot</h2>\n<p>Your friendly web guide.</p></div>",
        successMessage: "Much better! Now let's round those sharp corners."
    },
    {
        story: "To round the corners, we use the <code>border-radius</code> property. Let's give it a value of <code>8px</code>. Add this to your <code>.profile-card</code> rule.",
        objective: "Add border-radius to the profile card.",
        file: "style.css",
        hint: "Add <code>border-radius: 8px;</code> inside the <code>.profile-card</code> braces.",
        solution: /\.profile-card\s*\{(?=.*border\s*:[^;]+;)(?=.*padding\s*:\s*16px\s*;)(?=.*border-radius\s*:\s*8px\s*;).*\}/is,
        fullAnswer: ".profile-card {\n  border: 1px solid gray;\n  padding: 16px;\n  border-radius: 8px;\n}",
        preview: true,
        baseHtml: "<div class=\"profile-card\"><h2>Browser Bot</h2>\n<p>Your friendly web guide.</p></div>",
        successMessage: "Bleep bloop! That looks like a professional card! You've combined HTML and CSS!"
    },
    // --- Project 2: Nav Bar ---
    {
        story: "Great job! Let's start a new project: a navigation bar. First, the HTML. We'll use semantic tags: <code>&lt;nav&gt;</code> for the whole bar, <code>&lt;ul&gt;</code> for the list of links, and <code>&lt;li&gt;</code> for each item containing an <code>&lt;a&gt;</code> tag.",
        objective: "Create the HTML for a <nav> bar.",
        file: "index.html",
        hint: "Structure: <code>&lt;nav&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=\"#\"&gt;Home&lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href=\"#\"&gt;About&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/nav&gt;</code>",
        solution: /<nav>\s*<ul>\s*<li>\s*<a.*>.*Home.*<\/a>\s*<\/li>\s*<li>\s*<a.*>.*About.*<\/a>\s*<\/li>\s*<\/ul>\s*<\/nav>/is,
        fullAnswer: "<nav>\n  <ul>\n    <li><a href=\"#\">Home</a></li>\n    <li><a href=\"#\">About</a></li>\n  </ul>\n</nav>",
        preview: true,
        baseHtml: "", // Starts a new project
        successMessage: "Bzzzt! That's perfect HTML. But it looks like a bulleted list. Let's fix that with CSS."
    },
    {
        story: "Switching to CSS! First, let's give the <code>&lt;nav&gt;</code> a <code>background-color: #333;</code> so we can see it. Then, target the <code>nav ul</code> and set <code>list-style: none;</code> (removes bullets) and <code>padding: 0;</code> (removes default list padding).",
        objective: "Style the <nav> and <ul>.",
        file: "style.css",
        hint: "You need two rules: <code>nav { ... }</code> and <code>nav ul { ... }</code>",
        solution: /nav\s*\{\s*background-color\s*:\s*#333\s*;\s*\}\s*nav\s+ul\s*\{\s*list-style\s*:\s*none\s*;\s*padding\s*:\s*0\s*;\s*\}/is,
        fullAnswer: "nav {\n  background-color: #333;\n}\nnav ul {\n  list-style: none;\n  padding: 0;\n}",
        preview: true,
        baseHtml: "<nav>\n  <ul>\n    <li><a href=\"#\">Home</a></li>\n    <li><a href=\"#\">About</a></li>\n  </ul>\n</nav>",
        successMessage: "Great! The bullets are gone. But the links are still stacked. Let's fix that."
    },
    {
        story: "This is the magic part! To make the <code>&lt;li&gt;</code> items line up horizontally, we use Flexbox. Add <code>display: flex;</code> to your <code>nav ul</code> rule. This tells the <code>&lt;ul&gt;</code> to act as a flexible container.",
        objective: "Use 'display: flex' to make the list horizontal.",
        file: "style.css",
        hint: "Add <code>display: flex;</code> inside your <code>nav ul { ... }</code> rule.",
        solution: /nav\s+ul\s*\{(?=.*list-style\s*:\s*none\s*;)(?=.*padding\s*:\s*0\s*;)(?=.*display\s*:\s*flex\s*;).*\}/is,
        fullAnswer: "nav ul {\n  list-style: none;\n  padding: 0;\n  display: flex;\n}",
        preview: true,
        baseHtml: "<nav>\n  <ul>\n    <li><a href=\"#\">Home</a></li>\n    <li><a href=\"#\">About</a></li>\n  </ul>\n</nav>",
        successMessage: "Bloop! Just like that, they're in a row. That's Flexbox! Now let's style the links."
    },
    {
        story: "Finally, let's style the links themselves. Target <code>nav a</code>. Set their <code>color: white;</code>, give them <code>padding: 16px;</code> (so they are easier to click), and set <code>text-decoration: none;</code> (to remove the underline).",
        objective: "Style the <a> tags in the nav.",
        file: "style.css",
        hint: "Create a new rule: Code: <code>nav a { color: white; padding: 16px; text-decoration: none; }</code>",
        solution: /nav\s+a\s*\{\s*color\s*:\s*white\s*;\s*padding\s*:\s*16px\s*;\s*text-decoration\s*:\s*none\s*;\s*\}/is,
        fullAnswer: "nav a {\n  color: white;\n  padding: 16px;\n  text-decoration: none;\n}",
        preview: true,
        baseHtml: "<nav>\n  <ul>\n    <li><a href=\"#\">Home</a></li>\n    <li><a href=\"#\">About</a></li>\n  </ul>\n</nav>",
        successMessage: "BZZZZT! Look at that! You've built a professional navigation bar.",
    },
    // --- Project 3: Contact Form ---
    {
        story: "Excellent work! Now for a real challenge: a multi-part contact form. First, create a <code>&lt;div&gt;</code> with a class of <code>form-container</code> to hold our form.",
        objective: "Create a <div> with class 'form-container'.",
        file: "index.html",
        hint: "Use <code>&lt;div class=\"form-container\"&gt;&lt;/div&gt;</code>",
        solution: /<div\s+class="form-container"\s*>\s*<\/div>/is,
        fullAnswer: "<div class=\"form-container\">\n</div>",
        preview: true,
        baseHtml: "", // Starts a new project
        successMessage: "Perfect container. Now, let's add the <form> tag inside it."
    },
    {
        story: "Add an empty <code>&lt;form&gt;</code> tag inside your <code>form-container</code>.",
        objective: "Add a <form> tag.",
        file: "index.html",
        hint: "Nest <code>&lt;form&gt;&lt;/form&gt;</code> inside the <code>&lt;div&gt;</code>.",
        solution: /<div\s+class="form-container"\s*>\s*<form>\s*<\/form>\s*<\/div>/is,
        fullAnswer: "<div class=\"form-container\">\n  <form>\n  </form>\n</div>",
        preview: true,
        successMessage: "Great! Now let's add our first form field: a name input."
    },
    {
        story: "Let's add a name field. We need two tags: a <code>&lt;label&gt;</code> and an <code>&lt;input&gt;</code>. The label's <code>for</code> attribute must match the input's <code>id</code>.",
        objective: "Add a <label> and <input> for 'name'.",
        file: "index.html",
        hint: "Add <code>&lt;label for=\"name\"&gt;Name:&lt;/label&gt;&lt;input id=\"name\"&gt;</code> inside the <code>&lt;form&gt;</code>.",
        solution: /<form>[\s\S]*?<label\s+for="name"[\s\S]*?>[\s\S]*?<\/label>[\s\S]*?<input\s+id="name"[\s\S]*?>[\s\S]*?<\/form>/is,
        fullAnswer: "<div class=\"form-container\">\n  <form>\n    <label for=\"name\">Name:</label>\n    <input id=\"name\">\n  </form>\n</div>",
        preview: true,
        successMessage: "Excellent! That's a proper input. Now, let's add a message box."
    },
    {
        story: "Time to add a <code>&lt;textarea&gt;</code> so users can write a message. Give it an <code>id=\"msg\"</code> so the <code>&lt;label&gt;</code> can link to it.",
        objective: "Add a <textarea> for the message.",
        file: "index.html",
        hint: "Add <code>&lt;label for=\"msg\"&gt;Message:&lt;/label&gt;&lt;textarea id=\"msg\"&gt;&lt;/textarea&gt;</code>.",
        solution: /<form>[\s\S]*?<label\s+for="name"[\s\S]*?>[\s\S]*?<\/label>[\s\S]*?<input\s+id="name"[\s\S]*?>[\s\S]*?<label\s+for="msg"[\s\S]*?>[\s\S]*?<\/label>[\s\S]*?<textarea\s+id="msg"[\s\S]*?>[\s\S]*?<\/textarea>[\s\S]*?<\/form>/is,
        fullAnswer: "<div class=\"form-container\">\n  <form>\n    <label for=\"name\">Name:</label>\n    <input id=\"name\">\n    <label for=\"msg\">Message:</label>\n    <textarea id=\"msg\"></textarea>\n  </form>\n</div>",
        preview: true,
        successMessage: "Perfect! Just one more thing for this form."
    },
    {
        story: "Add a <code>&lt;button&gt;</code> tag at the end of your form. Make it say 'Send'.",
        objective: "Add a <button> to the form.",
        file: "index.html",
        hint: "Add <code>&lt;button&gt;Send&lt;/button&gt;</code> inside the <code>&lt;form&gt;</code>, after the textarea.",
        solution: /<form>[\s\S]*?<label\s+for="name"[\s\S]*?>[\s\S]*?<\/label>[\s\S]*?<input\s+id="name"[\s\S]*?>[\s\S]*?<label\s+for="msg"[\s\S]*?>[\s\S]*?<\/label>[\s\S]*?<textarea\s+id="msg"[\s\S]*?>[\s\S]*?<\/textarea>[\s\S]*?<button[\s\S]*?>\s*Send\s*<\/button>[\s\S]*?<\/form>/is,
        fullAnswer: "<div class=\"form-container\">\n  <form>\n    <label for=\"name\">Name:</label>\n    <input id=\"name\">\n    <label for=\"msg\">Message:</label>\n    <textarea id=\"msg\"></textarea>\n    <button>Send</button>\n  </form>\n</div>",
        preview: true,
        successMessage: "Excellent! The HTML is done. Time to make it look good with CSS."
    },
    // --- Project 4: Data Table ---
    {
        story: "New project! A data table. Let's start with the HTML for a 'Top Scores' table. Use <code>&lt;table&gt;</code>, <code>&lt;thead&gt;</code> (for headers), and <code>&lt;tbody&gt;</code> (for the body).",
        objective: "Create the HTML structure for a <table>.",
        file: "index.html",
        hint: "<code>&lt;table&gt;&lt;thead&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;/tbody&gt;&lt;/table&gt;</code>",
        solution: /<table>\s*<thead>\s*<\/thead>\s*<tbody>\s*<\/tbody>\s*<\/table>/i,
        fullAnswer: "<table>\n  <thead>\n  </thead>\n  <tbody>\n  </tbody>\n</table>",
        preview: true,
        baseHtml: "", // Starts a new project
        successMessage: "Perfect structure. Now let's add the header row."
    },
    {
        story: "Inside the <code>&lt;thead&gt;</code>, add a <code>&lt;tr&gt;</code> (table row) with two <code>&lt;th&gt;</code> (table header) cells: 'Player' and 'Score'.",
        objective: "Add the <thead> content.",
        file: "index.html",
        hint: "<code>&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Player&lt;/th&gt;&lt;th&gt;Score&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;</code>",
        solution: /<thead>\s*<tr>\s*<th>\s*Player\s*<\/th>\s*<th>\s*Score\s*<\/th>\s*<\/tr>\s*<\/thead>/i,
        fullAnswer: "<table>\n  <thead>\n    <tr>\n      <th>Player</th>\n      <th>Score</th>\n    </tr>\n  </thead>\n  <tbody>\n  </tbody>\n</table>",
        preview: true,
        successMessage: "Great! Now for the data rows in the <code>&lt;tbody&gt;</code>."
    },
    {
        story: "Inside the <code>&lt;tbody&gt;</code>, add two <code>&lt;tr&gt;</code>s. Each one needs two <code>&lt;td&gt;</code> (table data) cells. First row: 'Bot' and '1000'. Second row: 'User' and '999'.",
        objective: "Add the <tbody> content.",
        file: "index.html",
        hint: "<code>&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;Bot&lt;/td&gt;&lt;td&gt;1000&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;User&lt;/td&gt;&lt;td&gt;999&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;</code>",
        solution: /<tbody>\s*<tr>\s*<td>\s*Bot\s*<\/td>\s*<td>\s*1000\s*<\/td>\s*<\/tr>\s*<tr>\s*<td>\s*User\s*<\/td>\s*<td>\s*999\s*<\/td>\s*<\/tr>\s*<\/tbody>/i,
        fullAnswer: "<table>\n  ...\n  <tbody>\n    <tr>\n      <td>Bot</td>\n      <td>1000</td>\n    </tr>\n    <tr>\n      <td>User</td>\n      <td>999</td>\n    </tr>\n  </tbody>\n</table>",
        preview: true,
        successMessage: "HTML complete! It's ugly, but the data is structured. Let's fix it with CSS."
    },
    {
        story: "Switching to <code>style.css</code>. Let's make the <code>&lt;table&gt;</code> full-width and merge its borders. Target <code>table</code> and set <code>width: 100%;</code> and <code>border-collapse: collapse;</code>.",
        objective: "Style the <table>.",
        file: "style.css",
        hint: "<code>table { width: 100%; border-collapse: collapse; }</code>",
        solution: /table\s*\{\s*width\s*:\s*100%\s*;\s*border-collapse\s*:\s*collapse\s*;\s*\}/i,
        fullAnswer: "table {\n  width: 100%;\n  border-collapse: collapse;\n}",
        preview: true,
        baseHtml: "<table>\n  <thead>\n    <tr>\n      <th>Player</th>\n      <th>Score</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td>Bot</td>\n      <td>1000</td>\n    </tr>\n    <tr>\n      <td>User</td>\n      <td>999</td>\n    </tr>\n  </tbody>\n</table>",
        successMessage: "Good start. Now we need to add borders to the cells."
    },
    {
        story: "Let's style the cells. Target <code>th, td</code> (both headers and data). Give them <code>border: 1px solid #ccc;</code>, <code>padding: 8px;</code>, and <code>text-align: left;</code>.",
        objective: "Style the <th> and <td> cells.",
        file: "style.css",
        hint: "<code>th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }</code>",
        solution: /th\s*,\s*td\s*\{\s*border\s*:\s*1px\s+solid\s+#ccc\s*;\s*padding\s*:\s*8px\s*;\s*text-align\s*:\s*left\s*;\s*\}/i,
        fullAnswer: "th, td {\n  border: 1px solid #ccc;\n  padding: 8px;\n  text-align: left;\n}",
        preview: true,
        baseHtml: "<table>\n  <thead>\n    <tr>\n      <th>Player</th>\n      <th>Score</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td>Bot</td>\n      <td>1000</td>\n    </tr>\n    <tr>\n      <td>User</td>\n      <td>999</td>\n    </tr>\n  </tbody>\n</table>",
        successMessage: "Bleep! That looks 100x better. Let's make the header stand out."
    },
    {
        story: "Let's give the header row a background color. Target <code>thead tr</code> and set <code>background-color: #f0f0f0;</code>.",
        objective: "Style the table header row.",
        file: "style.css",
        hint: "<code>thead tr { background-color: #f0f0f0; }</code>",
        solution: /thead\s+tr\s*\{\s*background-color\s*:\s*#f0f0f0\s*;\s*\}/i,
        fullAnswer: "thead tr {\n  background-color: #f0f0f0;\n}",
        preview: true,
        baseHtml: "<table>\n  <thead>\n    <tr>\n      <th>Player</th>\n      <th>Score</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td>Bot</td>\n      <td>1000</td>\n    </tr>\n    <tr>\n      <td>User</td>\n      <td>999</td>\n    </tr>\n  </tbody>\n</table>",
        successMessage: "Nice! Now for the final touch: 'zebra striping'."
    },
    {
        story: "We can style *every other* body row using the <code>:nth-child(even)</code> pseudo-class. Target <code>tbody tr:nth-child(even)</code> and set <code>background-color: #f9f9f9;</code>.",
        objective: "Add 'zebra striping' to table rows.",
        file: "style.css",
        hint: "<code>tbody tr:nth-child(even) { background-color: #f9f9f9; }</code>",
        solution: /tbody\s+tr:nth-child\(even\)\s*\{\s*background-color\s*:\s*#f9f9f9\s*;\s*\}/i,
        fullAnswer: "tbody tr:nth-child(even) {\n  background-color: #f9f9f9;\n}",
        preview: true,
        baseHtml: "<table>\n  <thead>\n    <tr>\n      <th>Player</th>\n      <th>Score</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td>Bot</td>\n      <td>1000</td>\n    </tr>\n    <tr>\n      <td>User</td>\n      <td>999</td>\n    </tr>\n    <tr>\n      <td>Alice</td>\n      <td>950</td>\n    </tr>\n  </tbody>\n</table>",
        successMessage: "Bzzzt! A perfectly styled table. You're mastering CSS!"
    },
    // --- Project 5: Responsive Layout ---
    {
        story: "Time for our most advanced project: a responsive layout! First, the HTML. We'll build a blog layout with <code>&lt;div class=\"blog-layout\"&gt;</code> containing an <code>&lt;article&gt;</code> and an <code>&lt;aside&gt;</code> (sidebar).",
        objective: "Create HTML for a responsive layout.",
        file: "index.html",
        hint: "<code>&lt;div class=\"blog-layout\"&gt;&lt;article&gt;Blog Post...&lt;/article&gt;&lt;aside&gt;Sidebar...&lt;/aside&gt;&lt;/div&gt;</code>",
        solution: /<div\s+class="blog-layout"\s*>[\s\S]*?<article>[\s\S]*?<\/article>[\s\S]*?<aside>[\s\S]*?<\/aside>[\s\S]*?<\/div>/is,
        fullAnswer: "<div class=\"blog-layout\">\n  <article>\n    <h2>Blog Post Title</h2>\n    <p>This is the main content...</p>\n  </article>\n  <aside>\n    <h3>About</h3>\n    <p>This is the sidebar...</p>\n  </aside>\n</div>",
        preview: true,
        baseHtml: "", // Starts a new project
        successMessage: "Perfect semantic structure. Now, let's use CSS Grid to make it a layout."
    },
    {
        story: "Switching to CSS. Target <code>.blog-layout</code>. Set <code>display: grid;</code> and define two columns with <code>grid-template-columns: 3fr 1fr;</code> (the article gets 3 parts, the sidebar 1 part). Also add <code>gap: 20px;</code>.",
        objective: "Create a 2-column layout with CSS Grid.",
        file: "style.css",
        hint: "<code>.blog-layout { display: grid; grid-template-columns: 3fr 1fr; gap: 20px; }</code>",
        solution: /\.blog-layout\s*\{\s*display\s*:\s*grid\s*;\s*grid-template-columns\s*:\s*3fr\s+1fr\s*;\s*gap\s*:\s*20px\s*;\s*\}/is,
        fullAnswer: ".blog-layout {\n  display: grid;\n  grid-template-columns: 3fr 1fr;\n  gap: 20px;\n}",
        preview: true,
        baseHtml: "<div class=\"blog-layout\">\n  <article style=\"border:1px solid white; padding:10px;\">\n    <h2>Blog Post Title</h2>\n    <p>This is the main content...</p>\n  </article>\n  <aside style=\"border:1px solid gray; padding:10px;\">\n    <h3>About</h3>\n    <p>This is the sidebar...</p>\n  </aside>\n</div>",
        successMessage: "Bleep! Instant two-column layout! But what happens on a small screen? (Try resizing the preview, it's not good!)"
    },
    {
        story: "This is where Media Queries come in. We can apply different styles for small screens. Let's make our layout stack to one column. Add a media query: <code>@media (max-width: 600px) { ... }</code>",
        objective: "Add a media query for small screens.",
        file: "style.css",
        hint: "<code>@media (max-width: 600px) { /* Styles go here */ }</code>",
        solution: /@media\s*\(max-width\s*:\s*600px\)\s*\{\s*\}/i,
        fullAnswer: "@media (max-width: 600px) {\n  \n}",
        preview: true,
        baseHtml: "<div class=\"blog-layout\">\n  <article style=\"border:1px solid white; padding:10px;\">\n    <h2>Blog Post Title</h2>\n    <p>This is the main content...</p>\n  </article>\n  <aside style=\"border:1px solid gray; padding:10px;\">\n    <h3>About</h3>\n    <p>This is the sidebar...</p>\n  </aside>\n</div>",
        successMessage: "Great! Now let's add the responsive style *inside* that query."
    },
    {
        story: "Inside your media query, target <code>.blog-layout</code> and change <code>grid-template-columns</code> to <code>1fr;</code>. This will make it a single column.",
        objective: "Make the layout 1-column on small screens.",
        file: "style.css",
        hint: "<code>@media (max-width: 600px) { .blog-layout { grid-template-columns: 1fr; } }</code>",
        solution: /@media\s*\(max-width\s*:\s*600px\)\s*\{\s*\.blog-layout\s*\{\s*grid-template-columns\s*:\s*1fr\s*;\s*\}\s*\}/is,
        fullAnswer: ".blog-layout {\n  display: grid;\n  grid-template-columns: 3fr 1fr;\n  gap: 20px;\n}\n\n@media (max-width: 600px) {\n  .blog-layout {\n    grid-template-columns: 1fr;\n  }\n}",
        preview: true,
        baseHtml: "<div class=\"blog-layout\">\n  <article style=\"border:1px solid white; padding:10px;\">\n    <h2>Blog Post Title</h2>\n    <p>This is the main content...</p>\n  </article>\n  <aside style=\"border:1px solid gray; padding:10px;\">\n    <h3>About</h3>\n    <p>This is the sidebar...</p>\n  </aside>\n</div>",
        successMessage: "Bzzzt! Now resize your preview window (if you can). See it stack? That's responsive design!"
    },
    // --- Project 6: Interactive Card ---
{
        story: "Let's style the <code>.product-card</code>. Give it <code>border: 1px solid #ccc;</code>, <code>border-radius: 8px;</code>, <code>width: 300px;</code>, and <code>box-shadow: 0 2px 4px rgba(0,0,0,0.1);</code>. Crucially, add <code>position: relative;</code> so we can position the badge inside it.",
        objective: "Style the card and set 'position: relative'.",
        file: "style.css",
        hint: "Don't forget <code>position: relative;</code>! It's the key for the next step.",
        // Flexible solution for just this one rule
        solution: /\.product-card\s*\{[\s\S]*?position\s*:\s*relative[\s\S]*?\}/is,
        // Correct fullAnswer (it's the first step, so it's simple)
        fullAnswer: ".product-card {\n  border: 1px solid #ccc;\n  border-radius: 8px;\n  width: 300px;\n  box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n  position: relative;\n}",
        preview: true,
        baseHtml: "<div class=\"product-card\">\n  <img src=\"https://placehold.co/300x200\" alt=\"Product\" style=\"width:100%; border-radius: 8px 8px 0 0;\">\n  <h3 style=\"padding:0 16px;\">Product Name</h3>\n  <p style=\"padding:0 16px 16px;\">$99</p>\n  <div class=\"badge\">Sale!</div>\n</div>",
        successMessage: "Great! Now that the card is 'relative', we can position the badge 'absolutely'."
    },
    {
        story: "Let's style the <code>.badge</code>. Give it <code>position: absolute;</code>. This takes it out of the normal flow. Then, set <code>top: 10px;</code> and <code>right: 10px;</code>. Add <code>background-color: red;</code>, <code>color: white;</code>, and <code>padding: 4px 8px;</code>.",
        objective: "Use 'position: absolute' to place the badge.",
        file: "style.css",
        hint: "<code>.badge { position: absolute; top: 10px; right: 10px; ... }</code>",
        // Cumulative solution: checks for BOTH rules
        solution: /([\s\S]*?\.product-card[\s\S]*?\{[\s\S]*?position\s*:\s*relative[\s\S]*?\})([\s\S]*?\.badge\s*\{[\s\S]*?position\s*:\s*absolute[\s\S]*?top\s*:\s*10px[\s\S]*?right\s*:\s*10px[\s\S]*?\})/is,
        // Cumulative fullAnswer: includes BOTH rules
        fullAnswer: ".product-card {\n  border: 1px solid #ccc;\n  border-radius: 8px;\n  width: 300px;\n  box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n  position: relative;\n}\n\n.badge {\n  position: absolute;\n  top: 10px;\n  right: 10px;\n  background-color: red;\n  color: white;\n  padding: 4px 8px;\n  border-radius: 4px;\n}",
        preview: true,
        baseHtml: "<div class=\"product-card\">\n  <img src=\"https://placehold.co/300x200\" alt=\"Product\" style=\"width:100%; border-radius: 8px 8px 0 0;\">\n  <h3 style=\"padding:0 16px;\">Product Name</h3>\n  <p style=\"padding:0 16px 16px;\">$99</p>\n  <div class=\"badge\">Sale!</div>\n</div>",
        successMessage: "Bloop! Look at that! The badge is perfectly placed. Now for the final interaction."
    },
    {
        story: "Let's make the card 'pop' on hover. First, add <code>transition: transform 0.3s ease;</code> to the <code>.product-card</code> rule.",
        objective: "Add 'transition' to the product card.",
        file: "style.css",
        hint: "Add <code>transition: transform 0.3s ease;</code> to your <code>.product-card { ... }</code> rule.",
        // Cumulative solution: checks for .product-card (with transition) and .badge
        solution: /([\s\S]*?\.product-card[\s\S]*?\{[\s\S]*?position\s*:\s*relative[\s\S]*?transition\s*:\s*transform\s+0\.3s\s+ease[\s\S]*?\})([\s\S]*?\.badge\s*\{[\s\S]*?position\s*:\s*absolute[\s\S]*?\})/is,
        // Cumulative fullAnswer: includes BOTH rules, with the new transition
        fullAnswer: ".product-card {\n  border: 1px solid #ccc;\n  border-radius: 8px;\n  width: 300px;\n  box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n  position: relative;\n  transition: transform 0.3s ease;\n}\n\n.badge {\n  position: absolute;\n  top: 10px;\n  right: 10px;\n  background-color: red;\n  color: white;\n  padding: 4px 8px;\n  border-radius: 4px;\n}",
        preview: true,
        baseHtml: "<div class=\"product-card\">\n  <img src=\"https://placehold.co/300x200\" alt=\"Product\" style=\"width:100%; border-radius: 8px 8px 0 0;\">\n  <h3 style=\"padding:0 16px;\">Product Name</h3>\n  <p style=\"padding:0 16px 16px;\">$99</p>\n  <div class=\"badge\">Sale!</div>\n</div>",
        successMessage: "The transition is set. Now, let's add the hover effect itself."
    },
    {
        story: "Finally, create a new rule for <code>.product-card:hover</code>. Inside, set <code>transform: scale(1.05);</code>. This will make it grow by 5%.",
        objective: "Use ':hover' and 'transform' to scale the card.",
        file: "style.css",
        hint: "<code>.product-card:hover { transform: scale(1.05); }</code>",
        // Cumulative solution: checks for all THREE rules
        solution: /([\s\S]*?\.product-card[\s\S]*?\{[\s\S]*?transition\s*:\s*transform\s+0\.3s\s+ease[\s\S]*?\})([\s\S]*?\.badge\s*\{[\s\S]*?position\s*:\s*absolute[\s\S]*?\})([\s\S]*?\.product-card:hover\s*\{\s*transform\s*:\s*scale\(1.05\)\s*;\s*\})/is,
        // Cumulative fullAnswer: includes all THREE rules
        fullAnswer: ".product-card {\n  border: 1px solid #ccc;\n  border-radius: 8px;\n  width: 300px;\n  box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n  position: relative;\n  transition: transform 0.3s ease;\n}\n\n.badge {\n  position: absolute;\n  top: 10px;\n  right: 10px;\n  background-color: red;\n  color: white;\n  padding: 4px 8px;\n  border-radius: 4px;\n}\n\n.product-card:hover {\n  transform: scale(1.05);\n}",
        preview: true,
        baseHtml: "<div class=\"product-card\">\n  <img src=\"https://placehold.co/300x200\" alt=\"Product\" style=\"width:100%; border-radius: 8px 8px 0 0;\">\n  <h3 style=\"padding:0 16px;\">Product Name</h3>\n  <p style=\"padding:0 16px 16px;\">$99</p>\n  <div class=\"badge\">Sale!</div>\n</div>",
        successMessage: "BZZZZT! Try hovering over the card. You've made a fully interactive element! Congratulations!"
    },
    {
        story: "Bleep bloop! You've completed the entire combined projects track! You built a profile card, a navbar, a form, a data table, a responsive grid, and an interactive card. You are a true web developer now!",
        objective: "You've completed all projects!",
        file: "index.html",
        hint: "There's no code! Just type 'Congratulations!' to finish.",
        solution: /^Congratulations!$/i,
        fullAnswer: "Congratulations!",
        preview: false,
        successMessage: "You've mastered HTML and CSS!"
    }
];



    const lessonTracks = {
        html: htmlLessons,
        css: cssLessons,
        combined: combinedLessons
    };

    // --- END: LESSON TRACKS EMBEDDED ---


    // --- Lesson Track Imports ---
    // We'll dynamically import these when a track is selected
    let currentLessonTrack = [];
    
    // --- DOM Elements ---
    const hubView = document.getElementById('hub-view');
    const gameView = document.getElementById('game-view');
    const hubButtons = document.querySelectorAll('.hub-button');
    const backToHubButton = document.getElementById('back-to-hub-button');
    
    const chatOutput = document.getElementById('chat-output');
    const terminalInput = document.getElementById('terminal-input');
    const objectiveEl = document.getElementById('objective');
    const fileInfoEl = document.getElementById('file-info');
    const resetButton = document.getElementById('reset-button');
    const hintButton = document.getElementById('hint-button');
    const showAnswerButton = document.getElementById('show-answer-button');
    const submitButton = document.getElementById('submit-button');
    
    const previewModal = document.getElementById('preview-modal');
    const previewIframe = document.getElementById('preview-iframe');
    const closeModalButton = document.getElementById('close-modal-button');

    const apiKey = ""; // API key will be provided by the environment

    // --- GAME STATE ---
    let gameState = {
        level: 0,
        track: null, // 'html', 'css', 'combined'
        currentHtml: "", // Stores HTML progress for CSS/Combined tracks
        currentCss: "", // Stores CSS progress
        isBotTyping: false
    };

    // --- GEMINI API FUNCTION ---
    async function callGemini(codeToExplain) {
        // Find the "thinking" message and update it
        let thinkingMessage = Array.from(chatOutput.querySelectorAll('.chat-bubble-bot')).pop();
        if (!thinkingMessage || !thinkingMessage.textContent.includes("Bleep!")) {
             thinkingMessage = appendToTerminal("Bleep! Let me think... Squawk!", 'bot');
        }

        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const systemPrompt = "You are Browser Bot, a friendly, encouraging robot who is an expert in HTML and CSS. A beginner developer is learning. Your job is to explain a piece of code to them in simple, clear, and encouraging terms. Keep your explanation concise (2-4 sentences) and focused on the code's purpose and how it works. Start with a friendly 'Bleep!' or 'Great job!'.";
        const userQuery = `Please explain this line of code to me:\n\n\`\`\`\n${codeToExplain}\n\`\`\``;

        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
        };

        let response;
        let retries = 0;
        const maxRetries = 5;
        while (retries < maxRetries) {
            try {
                response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const result = await response.json();
                    const candidate = result.candidates?.[0];
                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        // Replace the "thinking" message with the real one
                        if (thinkingMessage) {
                            typeMessage(thinkingMessage, text.replace(/\n/g, '<br>'));
                        }
                    } else {
                        throw new Error("Invalid response structure from API.");
                    }
                    return; // Success
                } else if (response.status === 429 || response.status >= 500) {
                    const delay = Math.pow(2, retries) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    retries++;
                } else {
                    throw new Error(`API request failed with status: ${response.status}`);
                }
            } catch (error) {
                retries++;
                if (retries >= maxRetries) {
                    console.error('Error calling Gemini API after retries:', error);
                    if (thinkingMessage) {
                        typeMessage(thinkingMessage, "Bzzzt! My circuits are a bit fuzzy. Couldn't explain that. Try again in a moment!");
                    }
                    return;
                }
                const delay = Math.pow(2, retries) * 1000 + Math.random() * 1000;
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
    }

    // --- CHAT & UI FUNCTIONS ---

    function autosizeTextarea() {
        const el = terminalInput;
        setTimeout(() => {
            el.style.cssText = 'height:auto; padding:0';
            el.style.cssText = 'height:' + el.scrollHeight + 'px';
        }, 0);
    }
    
    async function typeMessage(element, text) {
        // If element doesn't exist or already removed, stop.
        if (!element || !element.isConnected) return;

        gameState.isBotTyping = true;
        const prefixEl = element.querySelector('.bot-prefix'); // May not exist
        const contentEl = element.querySelector('.bot-content');

        // If content element doesn't exist (e.g., feedback bubble), find any span or fallback to element itself
        const targetEl = contentEl || element.querySelector('span') || element;
        targetEl.innerHTML = ''; // Clear existing content before typing

        // This regex splits the text by HTML tags or entities, keeping them as delimiters
        const tokens = text.split(/(&[a-z]+(?:;|)|<code>|<\/code>|<br>)/gi).filter(Boolean); // filter(Boolean) removes empty strings

        for (const token of tokens) {
             if (!element.isConnected) break; // Stop if element is removed mid-typing
            
            if (token.match(/(&[a-z]+(?:;|)|<code>|<\/code>|<br>)/gi)) {
                // If it's a tag or entity, add it instantly
                targetEl.innerHTML += token;
            } else {
                // If it's plain text, type it out
                for (const char of token) {
                    if (!element.isConnected) break; // Stop if element is removed mid-typing
                    targetEl.innerHTML += char;
                    // Only scroll if the chat output exists and is visible
                    if (chatOutput && chatOutput.offsetParent !== null) {
                         chatOutput.scrollTop = chatOutput.scrollHeight;
                    }
                    await new Promise(resolve => setTimeout(resolve, 15)); // Adjust typing speed here
                }
                 if (!element.isConnected) break;
            }
        }
        gameState.isBotTyping = false;
    }


    function appendToTerminal(html, type = 'bot') {
        const p = document.createElement('div');
        
        switch(type) {
            case 'bot':
                p.className = 'chat-bubble chat-bubble-bot flex';
                // Add a non-breaking space for a slight gap
                p.innerHTML = `<strong class="bot-prefix font-bold text-green-300 mr-1 flex-shrink-0">Bot:</strong><span class="bot-content"></span>`;
                chatOutput.appendChild(p);
                // Start typing animation
                typeMessage(p, html);
                break;
            case 'user':
                p.className = 'chat-bubble chat-bubble-user';
                // Use <pre> to preserve whitespace and newlines from user input
                p.innerHTML = `<pre class="font-mono whitespace-pre-wrap">${html}</pre>`;
                chatOutput.appendChild(p);
                break;
            case 'error':
                p.className = 'chat-bubble chat-bubble-error flex';
                p.innerHTML = `<strong class="bot-prefix font-bold text-red-200 mr-2 flex-shrink-0">Bot:</strong><span class="bot-content"></span>`;
                chatOutput.appendChild(p);
                typeMessage(p, html);
                break;
            case 'success':
                p.className = 'chat-bubble chat-bubble-bot flex';
                p.innerHTML = `<strong class="bot-prefix font-bold text-green-300 mr-2 flex-shrink-0">Bot:</strong><span class="bot-content"></span>`;
                chatOutput.appendChild(p);
                typeMessage(p, html);
                break;
            case 'hint':
                 // Check if the last message was already this hint to avoid duplicates
                const lastHint = chatOutput.querySelector('.chat-bubble-hint:last-child .bot-content');
                if (lastHint && lastHint.textContent === html) {
                    return lastHint.closest('.chat-bubble-hint'); // Return existing element if duplicate
                }
                p.className = 'chat-bubble chat-bubble-hint flex'; // Changed bot to hint
                p.innerHTML = `<strong class="bot-prefix font-bold text-yellow-300 mr-2 flex-shrink-0">Bot Hint:</strong><span class="bot-content"></span>`;
                chatOutput.appendChild(p);
                typeMessage(p, html);
                break;
            case 'feedback': // New type for answer feedback
                p.className = 'chat-bubble chat-bubble-feedback';
                p.innerHTML = `<span></span>`; // Use span for typing
                chatOutput.appendChild(p);
                typeMessage(p, html); // Type out feedback
                break;
            case 'action': // For buttons
                p.className = 'explain-button-container';
                p.innerHTML = html; // Directly insert the button HTML
                chatOutput.appendChild(p);
                // Manually trigger animation for button
                setTimeout(() => p.style.opacity = 1, 10);
                break;
        }

        // Always scroll down unless it's a non-auto-typing message type like 'user' or 'action'
        if (type !== 'user' && type !== 'action') {
            // Wait a tick for the element to render before scrolling
            setTimeout(() => {
                 if (chatOutput && chatOutput.offsetParent !== null) {
                    chatOutput.scrollTop = chatOutput.scrollHeight;
                 }
            }, 0);
        } else {
             // For user/action, scroll immediately
             if (chatOutput && chatOutput.offsetParent !== null) {
                 chatOutput.scrollTop = chatOutput.scrollHeight;
             }
        }
        return p; // Return the created element
    }

    function updateSidebar() {
        if (!currentLessonTrack || !currentLessonTrack.length || gameState.level >= currentLessonTrack.length) return;
        const level = currentLessonTrack[gameState.level];
        if (!level) return;
        
        objectiveEl.textContent = level.objective;
        fileInfoEl.innerHTML = `<code class="bg-gray-700 p-1 rounded text-yellow-300">${level.file}</code>`;
    }

    // --- GAME LOGIC ---

    function selectTrack(trackName) {
        try {
            currentLessonTrack = lessonTracks[trackName];
            if (!currentLessonTrack) {
                throw new Error(`Lesson track "${trackName}" not found.`);
            }

            gameState.track = trackName;
            gameState.level = 0;
            gameState.currentHtml = "";
            gameState.currentCss = "";
            
            hubView.classList.add('hidden');
            gameView.classList.remove('hidden');
            
            chatOutput.innerHTML = ''; // Clear previous chat
            terminalInput.disabled = false;
            terminalInput.value = '';
            autosizeTextarea();
            terminalInput.focus(); // Focus input when track starts
            
            startLevel(0);
        } catch (err) {
            console.error("Failed to load lesson track:", err);
            // Provide user feedback without alert
            const errorElement = document.createElement('div');
            errorElement.className = 'text-red-400 p-4 text-center';
            errorElement.textContent = "Error: Could not load the lesson track.";
            document.body.appendChild(errorElement); // Or append to a specific error area
            setTimeout(() => errorElement.remove(), 5000); // Remove after 5s
        }
    }

    function startLevel(levelIndex) {
        if (!currentLessonTrack || levelIndex >= currentLessonTrack.length) {
             if (currentLessonTrack && currentLessonTrack.length > 0) { // Check if track loaded
                 appendToTerminal("Bzzzt! You've completed the track! Well done! You can restart from the sidebar or go back to the hub.", 'success');
             }
            terminalInput.disabled = true;
            return;
        }
        
        const level = currentLessonTrack[levelIndex];
        if (!level) {
            console.error(`Level not found: ${gameState.track} ${levelIndex}`);
            return;
        }

        gameState.level = levelIndex;
        
        // Store base HTML if provided (for CSS/Combined tracks)
        // Reset progress specifically for *this* level if needed by the logic
        if (level.baseHtml !== undefined) {
             gameState.currentHtml = level.baseHtml; // Use the specific base for this level
        } else if (gameState.track === 'html' || (gameState.track === 'combined' && level.file === 'index.html')) {
             // If it's an HTML level in HTML or Combined, start fresh for preview accumulation?
             // This might depend on whether HTML should persist across levels
             // For now, let's keep currentHtml persisting unless baseHtml overrides
        }

        appendToTerminal(level.story); // This now triggers typing
        updateSidebar();
    }

    function processCommand(command) {
        // Prevent processing if bot is typing or track isn't ready
        if (gameState.isBotTyping || !currentLessonTrack || gameState.level >= currentLessonTrack.length) return; 
        
        const level = currentLessonTrack[gameState.level];
        if (!level) return;

        // Special case: 'ready' command
        if (level.solution === 'ready') {
            if (command.trim().toLowerCase() === 'ready') {
                handleCorrectCommand(command, level);
            } else {
                appendToTerminal(`Bloop! That's not right. Just type <code>ready</code> to continue.`, 'error');
            }
            return;
        }
        
        // Special case: 'Congratulations!' level
        if (level.solution instanceof RegExp && level.solution.source === "^Congratulations!$") {
             if (command.trim().toLowerCase() === 'congratulations!') {
                 handleCorrectCommand(command, level);
             } else {
                 appendToTerminal(`Bloop! Almost there! Type <code>Congratulations!</code> to finish.`, 'error');
             }
            return;
        }


        // Regular expression check
        // Make sure solution is a RegExp before using test()
        if (!(level.solution instanceof RegExp)) {
             console.error("Level solution is not a RegExp:", level);
             appendToTerminal("Bzzzt! Internal error checking this answer.", 'error');
             return;
        }
        const solutionRegex = level.solution; // It's already a RegExp object

        // Decide whether to trim based on multiline flag 's' or 'm'
        // Trim only if it's NOT a multiline regex
        const commandToTest = (solutionRegex.flags.includes('s') || solutionRegex.flags.includes('m'))
                             ? command // Don't trim multiline inputs
                             : command.trim(); // Trim single-line inputs
        
        if (solutionRegex.test(commandToTest)) {
            handleCorrectCommand(command, level);
        } else {
            // Add user's incorrect attempt to chat before showing error
             appendToTerminal(command.replace(/</g, "&lt;").replace(/>/g, "&gt;"), 'user');
            appendToTerminal(level.errorMessage || `Bloop! That doesn't look quite right. Give it another try!`, 'error');
        }
    }

    function handleCorrectCommand(command, level) {
         // Add user's correct attempt to chat (unless 'ready')
        if (command.trim().toLowerCase() !== 'ready') {
            appendToTerminal(command.replace(/</g, "&lt;").replace(/>/g, "&gt;"), 'user');
        }

        let previewHtml = gameState.currentHtml; // Start with existing HTML
        let previewCss = gameState.currentCss;   // Start with existing CSS

        // Update code progress based on track and file
         // Don't add 'ready' or 'congratulations' to code progress
        const lowerCommand = command.trim().toLowerCase();
        if (lowerCommand !== 'ready' && lowerCommand !== 'congratulations!') {
            if (level.file.endsWith('.html')) {
                gameState.currentHtml += command + '\n';
                 previewHtml = gameState.currentHtml; // Update preview HTML
            } else if (level.file.endsWith('.css')) {
                gameState.currentCss += command + '\n';
                 previewCss = gameState.currentCss; // Update preview CSS
            }
        }

        // Override previewHtml if baseHtml is explicitly set for this level (mainly for CSS track)
        if (level.baseHtml !== undefined) {
             previewHtml = level.baseHtml;
        }
        
        // --- Success Message ---
        // Wait for user message bubble to appear before typing success
        setTimeout(() => {
            appendToTerminal(level.successMessage, 'success');

            // --- Add "Explain this" button ---
            // Add button *after* success message starts typing
            if (level.solution !== 'ready' && lowerCommand !== 'congratulations!') {
                 const encodedCode = btoa(command); // Use btoa to safely store the code
                 const explainButtonHtml = `
                    <button 
                        class="gemini-explain-button" 
                        data-code-to-explain="${encodedCode}"
                    >
                        âœ¨ Explain this code
                    </button>
                `;
                // Append action button without typing animation
                const btnContainer = document.createElement('div');
                btnContainer.className = 'explain-button-container';
                btnContainer.innerHTML = explainButtonHtml;
                chatOutput.appendChild(btnContainer);
                chatOutput.scrollTop = chatOutput.scrollHeight;
            }

            // --- Open preview modal ---
            // Open modal after success message and button logic
            if (level.preview) {
                // Ensure CSS uses the accumulated progress for the combined track,
                // or just the current level's CSS for the CSS track.
                let finalCss = (gameState.track === 'css') ? command : previewCss;
                if (lowerCommand === 'ready' || lowerCommand === 'congratulations!') finalCss = previewCss; // Don't preview 'ready' as CSS

                openModal(previewHtml, finalCss);
            }

            // --- Move to the next level ---
            // Move to next level after a short delay to allow reading success message
             setTimeout(() => {
                startLevel(gameState.level + 1);
             }, 500); // 500ms delay

        }, 100); // Short delay to ensure user bubble is rendered

    }

    // --- MODAL FUNCTIONS ---
    function openModal(htmlContent, cssContent = "") {
        const iframeContent = `
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <style>
                    body { 
                        font-family: 'Inter', sans-serif; 
                        padding: 1rem;
                        color: #111827; /* gray-900 */
                        background-color: white; /* Ensure background isn't transparent */
                        margin: 0; /* Remove default body margin */
                    }
                    /* Add some base styles for better preview */
                    img { max-width: 100%; height: auto; }
                    button { padding: 0.5em 1em; margin: 0.5em 0; }
                    /* Inject lesson CSS */
                    ${cssContent}
                </style>
            </head>
            <body>
                <!-- Inject lesson HTML -->
                ${htmlContent}
            </body>
            </html>
        `;
        // Use try/catch for srcdoc in case of security issues in some environments
        try {
            previewIframe.srcdoc = iframeContent;
        } catch (e) {
            console.error("Error setting iframe srcdoc:", e);
            // Fallback or error message? For now, just log.
        }
        previewModal.classList.remove('hidden');
    }

    function closeModal() {
        previewModal.classList.add('hidden');
        try {
             previewIframe.srcdoc = ''; // Clear content
        } catch (e) {
            console.error("Error clearing iframe srcdoc:", e);
        }
    }

    // --- EVENT LISTENERS ---
    hubButtons.forEach(button => {
        button.addEventListener('click', () => {
            const track = button.getAttribute('data-track');
            selectTrack(track);
        });
    });

    backToHubButton.addEventListener('click', () => {
        gameView.classList.add('hidden');
        hubView.classList.remove('hidden');
         // Also reset game state when going back to hub
        gameState.track = null;
        gameState.level = 0;
        gameState.currentHtml = "";
        gameState.currentCss = "";
        currentLessonTrack = []; // Clear loaded track
        terminalInput.disabled = true; // Disable input on hub view
    });

    // Delegated listener for explain buttons
    chatOutput.addEventListener('click', (e) => {
        if (e.target.classList.contains('gemini-explain-button')) {
            const button = e.target;
            if (button.disabled || gameState.isBotTyping) return; // Prevent clicks while bot is typing

            const encodedCode = button.getAttribute('data-code-to-explain');
            try {
                const codeToExplain = atob(encodedCode); // Decode from Base64
                button.disabled = true; // Prevent multiple clicks
                button.textContent = "Bot is thinking...";
                
                // Append a new "thinking" message for the bot
                appendToTerminal("Bleep! Let me check my circuits...", 'bot'); // This starts typing
                
                // Call Gemini AFTER the thinking message starts typing
                // Use setTimeout to ensure thinking message bubble exists first
                 setTimeout(() => {
                    callGemini(codeToExplain).finally(() => {
                        // Attempt to remove the button after Gemini responds
                         if(button.parentElement && button.parentElement.contains(button)) {
                            button.parentElement.remove();
                         }
                    });
                 }, 50); // Small delay

            } catch (err) {
                console.error("Error decoding base64 string:", err);
                appendToTerminal("Bzzzt! I got my wires crossed trying to read that. Sorry!", 'error');
                 // Re-enable button on error? Maybe not, avoid spamming.
            }
        }
    });

    function submitCode() {
         // Prevent submission if bot is typing
        if (gameState.isBotTyping) return;

        if (terminalInput.value && !terminalInput.disabled) {
            const command = terminalInput.value; // Keep original formatting
            processCommand(command); // processCommand now handles adding user bubble if correct
            terminalInput.value = '';
            autosizeTextarea();
        }
    }

    terminalInput.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key === 'Enter') {
            e.preventDefault(); // Prevent new line on submission
            submitCode();
        }
    });

    submitButton.addEventListener('click', submitCode);

    terminalInput.addEventListener('input', autosizeTextarea);

    resetButton.addEventListener('click', () => {
        if (gameState.track) {
            // Restart the current track
            selectTrack(gameState.track);
        }
    });

    hintButton.addEventListener('click', () => {
        // Prevent hint if bot is typing or track/level invalid
        if (gameState.isBotTyping || !currentLessonTrack || gameState.level >= currentLessonTrack.length) return; 
        const level = currentLessonTrack[gameState.level];
        if (!level || !level.hint) return;
        appendToTerminal(level.hint, 'hint');
    });

    showAnswerButton.addEventListener('click', () => {
         // Prevent action if bot is typing or track/level invalid
        if (gameState.isBotTyping || !currentLessonTrack || gameState.level >= currentLessonTrack.length) return; 

        const currentLevelData = currentLessonTrack[gameState.level]; // Use a different variable name
        if (!currentLevelData) return;
        
        let answer;

        if (currentLevelData.solution === 'ready') {
            answer = 'ready';
        } else if (currentLevelData.fullAnswer) {
            answer = currentLevelData.fullAnswer;
        } else if (currentLevelData.solution instanceof RegExp) {
             // Basic attempt to clean up regex for display, might not be perfect
            answer = currentLevelData.solution.source
                        .replace(/\\s[*+]/g, ' ') // Replace whitespace markers
                        .replace(/\\/g, '')       // Remove backslashes
                        .replace(/\(\?=[^)]+\)/g, '') // Remove lookaheads
                        .replace(/[?*+]/g, ''); // Remove regex quantifiers (simplification)
        } else {
            answer = ''; // Fallback
        }

        terminalInput.value = answer; 
        autosizeTextarea();
        terminalInput.focus();
        
        appendToTerminal("Answer copied to your text box!", 'feedback');
    });


    closeModalButton.addEventListener('click', closeModal);
    previewModal.addEventListener('click', (e) => {
        if (e.target === previewModal) { // only close if clicking on the background
            closeModal();
        }
    });


    // --- INITIALIZE ---
    // Show the hub view on load, disable terminal input
    gameView.classList.add('hidden');
    hubView.classList.remove('hidden');
    terminalInput.disabled = true;

</script>

</body>
</html>

